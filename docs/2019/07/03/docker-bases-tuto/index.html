<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Docker, les bases | btor.fr</title><meta name="description" content="PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta itemprop="name" content="Thibaut BAYER"><meta itemprop="description" content="PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta itemprop="image" content="https://btor.fr/assets/images/docker-bases/main.png"><meta property="og:url" content="https://btor.fr/2019/07/03/docker-bases-tuto/"><meta property="og:type" content="website"><meta property="og:title" content="Docker, les bases | btor.fr"><meta property="og:site_name" content="btor.fr"><meta property="og:description" content="PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta property="og:image" content="https://btor.fr/assets/images/docker-bases/main.png"><meta name="twitter:url" content="https://btor.fr/2019/07/03/docker-bases-tuto/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Docker, les bases | btor.fr"><meta name="twitter:site" content="btor.fr"><meta name="twitter:description" content="PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta name="twitter:creator" content="@biiitor"><meta property="twitter:image" content="https://btor.fr/assets/images/docker-bases/main.png"><link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"><link rel="stylesheet" href="/assets/css/app.min.css"><link rel="alternate" type="application/rss+xml" title="btor.fr" href="/feed.xml"><link rel="canonical" href="/2019/07/03/docker-bases-tuto/"></head><body id="docker-les-bases" class="post-layout"><header class="header"> <a class="header__title" href="https://btor.fr/"><img width="75" src="/assets/images/logo/logo.dark.small.png"/></a><nav><ul class="header__list"><li><a href="/qui-suis-je">â“ Qui suis-je</a></li><li><a href="/help">â¤ï¸ Me soutenir</a></li></ul></nav></header><main class="ğŸ’ˆ"><div class="post"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><div class="post__header section-padding--double"><div class="grid-small"><h2 itemprop="name headline">Docker, les bases</h2><time class="post__date" datetime="2019-07-03T00:00:00-05:00" itemprop="datePublished">03/07/2019</time></div></div><div class="post__img"><div><figure class="absolute-bg" style="background-image: url('/assets/images/docker-bases/main.png');"></figure></div></div><div class="post__content section-padding"><div class="grid"><div id="markdown" itemprop="articleBody"><p>RÃ©guliÃ¨rement je me rends compte que certains dÃ©veloppeurs ne sont pas Ã  lâ€™aise avec Docker. Câ€™Ã©tait aussi mon cas au dÃ©but, Docker peut paraÃ®tre complexe et flou au premier abord puis rapidement il devient <strong>indispensable</strong>, mais pourquoi ?</p><p>Dans cet article, je tÃ¢cherai de revenir sur les principaux concepts en essayant de faire le plus simple possible. Si vous avez dÃ©jÃ  un niveau avancÃ© avec Docker, cet article nâ€™est pas fait pour vous.</p><h1 id="-cest-quoi-docker-">â“ Câ€™est quoi Docker ?</h1><blockquote><p>Docker est un logiciel libre permettant facilement de lancer des applications dans des conteneurs logiciels.</p></blockquote><p><em>Source wikipÃ©dia</em></p><p>Cool, mais du coup, quâ€™est ce quâ€™un conteneur ? Avant dâ€™expliquer le concept de conteneurisation, commenÃ§ons par comprendre la base: <strong>la virtualisation</strong>.</p><h3 id="-virtualisation-vs-conteneurisation">ğŸ³ Virtualisation VS Conteneurisation</h3><p>Ã‡a devrait parler Ã  beaucoup dâ€™entre vous, câ€™est le fait <strong>dâ€™Ã©muler</strong> un systÃ¨me dâ€™exploitation dans un autre, par exemple, au sein dâ€™un systÃ¨me dâ€™exploitation Windows 10, jâ€™Ã©mule un Linux, un MacOS ou mÃªme un Windows 3.1. Le logiciel permettant dâ€™Ã©muler nos systÃ¨mes dâ€™exploitation est appelÃ© un <strong>Hyperviseur</strong>.</p><p>Il existe deux types dâ€™hyperviseur:</p><ul><li><strong>Lâ€™hyperviseur de type 2</strong>:</li></ul><p><img src="/assets/images/docker-bases/hyperviseur_type_2.png" alt="" /> <em>Source wikipÃ©dia</em></p><p>Vous les connaissez certainement sans savoir quâ€™ils sont de type 2: VirtualBox et VMWare workstation. Le type 2 veut dire que lâ€™hyperviseur a besoin dâ€™un systÃ¨me dâ€™exploitation â€œhÃ´teâ€ (maitre) pour fonctionner. Par exemple, vous ne pouvez pas lancer Virtualbox seul sans Windows ou Ubuntu.</p><ul><li><strong>Lâ€™hyperviseur de type 1</strong>:</li></ul><p><img src="/assets/images/docker-bases/hyperviseur_type_1.png" alt="" /> <em>Source wikipÃ©dia</em></p><p>A la diffÃ©rence du type 2, le type 1 fonctionne directement comme un â€œsystÃ¨me hÃ´teâ€ et se charge de communiquer directement avec le matÃ©riel. Lâ€™avantage du type 1 est quâ€™il permet dâ€™avoir de meilleur performance Ã©tant donnÃ© quâ€™on dispose dâ€™une couche applicative en moins contrairement au type 2 oÃ¹ le systÃ¨me dâ€™exploitation hÃ´te, sera consommateur de ressources. Hyper-V (Microsoft) est un hyperviseur de type 1.</p><p>Et la conteneurisation dans tout Ã§a ?</p><p>Un conteneur, câ€™est grossiÃ¨rement la mÃªme chose quâ€™une machine virtuelle, notre conteneur va avoir son propre systÃ¨me <strong>SAUF</strong> que celui-ci communiquera directement avec le systÃ¨me dâ€™exploitation hÃ´te et pas nÃ©cessairement avec un hyperviseur. Lâ€™intÃ©rÃªt ? Un gain de performance pardi !</p><h3 id="ï¸-platformes-win-linux-mac">ğŸ–¥ï¸ Platformes (win, linux, mac)</h3><p>Maintenant que lâ€™on sait ce quâ€™est un hyperviseur, quâ€™on comprend la diffÃ©rence entre un conteneur et une machine virtuelle, est-ce quâ€™il y a une diffÃ©rence entre les diffÃ©rentes plateformes ?</p><p><img src="https://media.giphy.com/media/S3Ot3hZ5bcy8o/giphy.gif" alt="" /></p><p>Oh que oui !</p><p>Docker ne se comporte pas rÃ©ellement de la mÃªme faÃ§on en fonction des environnements. Docker se base sur les conteneurs LXC linux et propose une API plus accessible.</p><p>Vous voyez le problÃ¨me ?</p><p>Qui dit Linux, dit : On va avoir un problÃ¨me avec Windows et Mac. Effectivement, si vous utilisez Linux sur votre machine hÃ´te vous nâ€™aurez aucun problÃ¨me, Docker est supportÃ© nativement, par contre sous Windows et Mac vous aurez une couche supplÃ©mentaire pour faire fonctionner Dockerâ€¦ <strong>Une machine virtuelle !</strong></p><p><img src="https://media.giphy.com/media/LyJ6KPlrFdKnK/giphy.gif" alt="" /></p><p>Comme je vous lâ€™ai dit, Docker a besoin de Linux (LXC) pour fonctionner et quand vous nâ€™Ãªtes pas sous Linux, votre version de Docker (<code class="highlighter-rouge">DockerForMac</code> ou <code class="highlighter-rouge">DockerForWindows</code>) utilisera une machine virtuelle pour exÃ©cuter Docker. Câ€™est pour cela que vous remarquerez assez rapidement que vos applications conteneurisÃ©es sont plus lentes sur Windows et Mac (les temps de latences dÃ©pendent de votre utilisation/application, des inputs/outputs nÃ©cessaires etc) Rassurez-vous, câ€™est totalement transparent pour vous ! DockerForMac (ou DockerForWindows) sâ€™occupera lui mÃªme de gÃ©rer la machine virtuelle, vous nâ€™avez pas dâ€™hyperviseur Ã  installer. A noter aussi que Docker nâ€™est pas rÃ©servÃ© Ã  la conteneurisation dâ€™image Linux, sous Windows vous aurez le choix entre des conteneurs Windows ou Linux mais vous ne pouvez pas exÃ©cuter les deux en mÃªme temps, tout comme vous ne pourrez pas exÃ©cuter un conteneur Windows sous Linux.</p><p><strong>Debriefing</strong></p><ul><li>Docker est plus lent sous MacOs et Windows</li><li>Les conteneurs partagent le noyau hÃ´te (virtualisÃ© ou non)</li><li>On peut lancer des conteneurs de diffÃ©rents systÃ¨mes dâ€™exploitation tant que la systÃ¨me dâ€™exploitation qui gÃ¨re les conteneurs est le mÃªme que ceux-ci. Exemple : Un ordinateur sous windows 10 qui lance une machine virtuelle Ubuntu et qui dans celle ci aura des conteneurs sous debian.</li></ul><h1 id="ï¸-dockerfile-instructions-et-registry">ğŸ—’ï¸ Dockerfile, instructions et Registry</h1><blockquote><p>Si vous dÃ©sirez continuer Ã  lire cet article tout en lanÃ§ant les commandes, vous devez bien Ã©videmment avoir Docker dâ€™installÃ© et de fonctionnel)</p></blockquote><p>Maintenant que nous avons vu le principe mÃªme de Docker et de la conteneurisation, passons Ã  la pratique. Comme nous lâ€™avons vu, lâ€™objectif de Docker est de simplifier la crÃ©ation et la manipulation de conteneurs. Pour se faire, Docker met Ã  disposition une API simple qui attend des <strong>instructions</strong> pour fonctionner. Ces instructions sont dÃ©clarÃ©s au sein dâ€™un fichier nommÃ© <strong>Dockerfile</strong>.</p><p>Ce mÃªme fichier est utilisÃ© pour construire (build) lâ€™image, lâ€™image construite sera ensuite envoyÃ©e vers un â€œserveur Dockerâ€ quâ€™on appelle <strong>Registry</strong>. Le <strong>Docker Hub</strong> est un <strong>Registry</strong> gratuit mis Ã  disposition de tout le monde (des plans payant existent aussi) mais il existe aussi dâ€™autres Registry payant (plus performant, possibilitÃ© de gÃ©rer plusieurs repository privÃ©s etc). Vous pouvez aussi gÃ©rer vous mÃªme votre propre registry. Pour simplifier, Docker Hub est un peu le <strong>Github</strong> de git, vous avez le droit Ã  un repository privÃ© et Ã  autant de repository public que vous le dÃ©sirez et si vous dÃ©sirez avoir plus de repository privÃ©, bah vous payez â€¦ :)</p><p>Les images sont stockÃ©es avec des <code class="highlighter-rouge">Tag</code>, ces tags permettent de versionner les images sur le repository, par exemple si on regarde <a href="https://hub.docker.com/_/debian">les images disponibles pour Debian</a> On sâ€™aperÃ§oit quâ€™il existe des images pour plusieurs versions de Debian (Jessie, Buster, Stretch etc..) qui sont en stable mais aussi des versions expÃ©rimentales, testing, Release candidate etc.</p><h3 id="ï¸-lancer-son-premier-conteneur">âš™ï¸ Lancer son premier conteneur</h3><p>RÃ©cupÃ©rons une image de Debian et regardons ce quâ€™il se passe :</p><ul><li>Taper <code class="highlighter-rouge">docker run -it debian:jessie sh</code></li><li>Vous devriez normalement tomber sur un shell avec juste <code class="highlighter-rouge">#</code> dâ€™afficher.</li><li>Taper <code class="highlighter-rouge">cat /etc/debian_version</code></li><li>Vous devriez voir <code class="highlighter-rouge">8.11</code> sâ€™afficher</li><li>Nous sommes bien sur une version 8 de Debian, good !</li></ul><p>Sans presque rien faire, vous avez exÃ©cuter votre premier conteneur et vous avez exÃ©cutÃ© une commande dans celui-ci ! Congrats ! Revenons maintenant sur ce que nous avons tapÃ©:</p><ul><li><code class="highlighter-rouge">docker run</code> : Permet de rÃ©cupÃ©rer une image du Registry et de lâ€™exÃ©cuter, si vous dÃ©sirez uniquement rÃ©cupÃ©rer une image docker sans mÃªme lâ€™exÃ©cuter, vous pouvez utiliser la commande <code class="highlighter-rouge">docker pull</code>.</li><li><code class="highlighter-rouge">-it</code> : Permet de lancer le conteneur en mode interactif</li><li><code class="highlighter-rouge">debian:jessie</code>: Câ€™est lâ€™image quâ€™on veut rÃ©cupÃ©rer et exÃ©cuter, notons que <code class="highlighter-rouge">debian</code> est le nom du repository et <code class="highlighter-rouge">jessie</code> le tag de la version Ã  utiliser</li><li><code class="highlighter-rouge">sh</code> : La commande quâ€™on cherche Ã  lancer aprÃ¨s avoir lancer le conteneur</li></ul><p>En dâ€™autres termes, on a demandÃ© Ã  docker de rÃ©cupÃ©rer une image, la lancer et dâ€™exÃ©cuter une commande quâ€™on lui donne (<code class="highlighter-rouge">sh</code>) ! Câ€™est tout !</p><p>Les conteneurs sont sensÃ©s avoir une fonction unique, par exemple on pourrait utiliser un conteneur pour lancer un processus nginx, php-fpm, go etc.. Le conteneur peut lancer cette fonction et se terminer Ã  la fin du processus ou ne jamais sâ€™arrÃªter (le cas dâ€™un serveur web, dâ€™un worker etc.). Si vous dÃ©sirez arrÃªter lâ€™exÃ©cution dâ€™un conteneur qui tourne en rond, qui est un worker ou autre vous pouvez utiliser la commande <code class="highlighter-rouge">docker kill &lt;hash&gt;</code> ou <code class="highlighter-rouge">docker kill &lt;nom-conteneur&gt;</code>.</p><p>Reprenons la mÃªme image <code class="highlighter-rouge">debian:jessie</code> mais cette fois-ci nous lui demanderons de lancer le conteneur puis dâ€™exÃ©cuter la commande <code class="highlighter-rouge">cat /etc/debian_version</code> sans Ãªtre en mode interactif.</p><ul><li>Taper <code class="highlighter-rouge">docker run debian:jessie cat /etc/debian_version</code></li><li>La commande renvoie directement <code class="highlighter-rouge">8.11</code></li></ul><p><strong>Conclusion:</strong> ` Docker run` va rÃ©cupÃ©rer une image docker puis lâ€™exÃ©cuter, on peut exÃ©cuter lâ€™image en mode interactif pour interagir dans le conteneur ou tout simplement lancer lâ€™exÃ©cution dâ€™une commande/fonction afin dâ€™avoir la rÃ©ponse directement.</p><h3 id="ï¸-exec">â¡ï¸ Exec</h3><p><code class="highlighter-rouge">run</code> nous permettant de rÃ©cupÃ©rer et lancer une image, comment fait-on quand on a un conteneur dÃ©jÃ  lancÃ© et quâ€™on veut exÃ©cuter une commande Ã  lâ€™intÃ©rieur de celui ci sans forcÃ©ment passer Ã  chaque fois par le shell ? câ€™est lÃ  quâ€™<code class="highlighter-rouge">exec</code> intervient. LanÃ§ons <code class="highlighter-rouge">docker run nginx</code> dans une fenÃªtre, puis dans une autre :</p><ul><li><code class="highlighter-rouge">docker ps</code> pour afficher la liste des conteneurs en cours dâ€™exÃ©cution</li><li>On aperÃ§oit bien notre conteneur<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fdf20b921646  nginx "nginx -g 'daemon ofâ€¦"   6 seconds ago   Up 4 seconds    80/tcp   happy_jepsen
</code></pre></div></div></li><li>Essayons de rÃ©cupÃ©rer la version de debian en tapant <code class="highlighter-rouge">docker exec happy_jepsen cat /etc/debian_version</code> (<code class="highlighter-rouge">happy_jepsen</code> doit Ãªtre remplacÃ© par le nom de votre conteneur ou son hash, ici <code class="highlighter-rouge">fdf20b921646</code>)</li><li>Le conteneur rÃ©pond <code class="highlighter-rouge">9.9</code>, ce qui correspond bien Ã  la version <code class="highlighter-rouge">stretch-slim</code> disponible dans le <a href="https://github.com/nginxinc/docker-nginx/blob/b749353968a57ebd9da17e12d23f1a5fb62f9de9/mainline/stretch/Dockerfile">Dockerfile</a> de nginx</li></ul><p><strong>Conclusion:</strong> Il faut faire attention Ã  bien utiliser <code class="highlighter-rouge">docker run</code> et <code class="highlighter-rouge">docker exec</code>, on confond souvent les deux au dÃ©but. <code class="highlighter-rouge">run</code> =&gt; Je rÃ©cupÃ¨re et je lance lâ€™image (avec ou sans commande Ã  exÃ©cuter) <code class="highlighter-rouge">exec</code> =&gt; Je lance une commande dans un conteneur <strong>dÃ©jÃ </strong> lancÃ©.</p><h3 id="-votre-premier-conteneur-docker">ğŸ¥ Votre premier conteneur Docker</h3><p>Nous avons connaissance de quatre commandes docker : <code class="highlighter-rouge">run</code>, <code class="highlighter-rouge">exec</code>, <code class="highlighter-rouge">pull</code> et <code class="highlighter-rouge">ps</code>. Jusquâ€™Ã  prÃ©sent nous avons rÃ©cupÃ©rÃ© des images docker dÃ©jÃ  crÃ©e, mais quâ€™en est-il dâ€™une image quâ€™on souhaiterait crÃ©er ?</p><p>CommenÃ§ons par faire notre premier fichier <strong>Dockerfile</strong>:</p><ul><li>CrÃ©er un fichier nommÃ© <code class="highlighter-rouge">Dockerfile</code> et y ajouter :</li></ul><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> debian:jessie</span>

<span class="k">RUN </span><span class="nb">echo</span> <span class="s2">"toto"</span>
</code></pre></div></div><p>On y voit deux instructions :</p><ul><li><code class="highlighter-rouge">FROM</code> : Demande Ã  Docker de rÃ©cupÃ©rer une image (en lâ€™occurence <code class="highlighter-rouge">debian:jessie</code>)</li><li><code class="highlighter-rouge">RUN</code> : ExÃ©cute une commande systÃ¨me, Ã§a pourrait Ãªtre <code class="highlighter-rouge">ls</code>, <code class="highlighter-rouge">cp</code>, <code class="highlighter-rouge">cat</code> â€¦</li></ul><p>Les images Docker ont besoin dâ€™Ãªtre build pour ensuite pouvoir Ãªtre lancÃ©e. Pour lancer le build dâ€™une image, il suffit dâ€™utiliser la commande <code class="highlighter-rouge">docker build .</code>. On dit juste Ã  Docker de build lâ€™image courante, docker se chargera de prendre le fichier <code class="highlighter-rouge">Dockerfile</code> dans votre rÃ©pertoire courant. Vous pouvez aussi spÃ©cifier un chemin vers un Dockerfile en utilisant <code class="highlighter-rouge">docker build -f repertoire/Dockerfile .</code></p><p>Voici le retour de la commande:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> btor@dev<span class="nv">$ </span> docker build <span class="nt">-f</span> <span class="nb">test</span>/Dockerfile <span class="nb">.</span>
Sending build context to Docker daemon  3.928MB
Step 1/2 : FROM debian:jessie
 <span class="nt">---</span><span class="o">&gt;</span> 7cd9fb1ee74f
Step 2/2 : RUN <span class="nb">echo</span> <span class="s2">"toto"</span>
 <span class="nt">---</span><span class="o">&gt;</span> Using cache
 <span class="nt">---</span><span class="o">&gt;</span> 8831306e5a73
Successfully built 8831306e5a73
</code></pre></div></div><p>Trois choses importantes sont Ã  noter :</p><ul><li>On voit trÃ¨s clairement les deux Ã©tapes que docker exÃ©cute : FROM et RUN</li><li>Chaque Ã©tape Ã  son propre hash <code class="highlighter-rouge">7cd9fb1ee74f</code> pour le FROM et <code class="highlighter-rouge">8831306e5a73</code> pour le RUN, chaque Ã©tape/instruction va crÃ©er un nouveau layer (une couche).</li><li>Le build rÃ©sulte dâ€™un message <code class="highlighter-rouge">Successfully build 8831306e5a73</code></li></ul><h2 id="-les-coucheslayers">ğŸ“š Les couches/layers</h2><p>Pour chaque Ã©tape ou instruction que lâ€™ont Ã©cris dans notre Dockerfile, Docker va crÃ©er un layer avec un <code class="highlighter-rouge">hash</code> propre Ã  celui ci. Chaque layer est utilisable tel quel ! Oui oui ! Vous pouvez lancer un conteneur en vous basant sur le <code class="highlighter-rouge">hash</code> de votre layer (vous pouvez tester en tapant<code class="highlighter-rouge">docker run 8831306e5a73 cat /etc/debian_version</code>)</p><p><img src="https://media.giphy.com/media/2YntTHAxuJLZcKpOy9/giphy.gif" alt="" /></p><p>Vulgarisons la chose, voilÃ  ce que vous demandez Ã  Docker:</p><ul><li><strong>Vous:</strong> CrÃ©er moi une image qui hÃ©rite de <code class="highlighter-rouge">debian:jessie</code></li><li><strong>Docker:</strong> Câ€™est fait, lâ€™image est Ã©crite dans le cache avec le hash <code class="highlighter-rouge">7cd9fb1ee74f</code></li><li><strong>Vous:</strong> En utilisant cette image, lance la commande <code class="highlighter-rouge">echo "toto"</code></li><li><strong>Docker:</strong> Câ€™est fait, jâ€™ai rÃ©utiliser lâ€™image <code class="highlighter-rouge">debian:jessie</code> puis y ai lancÃ© la commande <code class="highlighter-rouge">echo "toto"</code> et jâ€™ai sauvegardÃ© le rÃ©sultat dans une nouvelle image avec le hash <code class="highlighter-rouge">8831306e5a73</code></li></ul><p>Pour chaque Ã©tape, docker crÃ©er une couche, câ€™est gÃ©nial parce que Ã§a nous permet Ã  la fois de tester ces Ã©tapes une Ã  une mais câ€™est aussi une bonne chose puisque Docker va Ãªtre capable de comprendre vos modifications sur le Dockerfile et de ne relancer que ce qui a Ã©tÃ© modifiÃ©, exemple :</p><p>Vous avez un dockerfile avec diffÃ©rentes Ã©tapes:</p><ul><li>Etape 1 / hash 111</li><li>Etape 2 / hash 222</li><li>Etape 3 / hash 333</li></ul><p>Vous lancez votre <code class="highlighter-rouge">docker build .</code> et vous vous rendez compte que votre Ã©tape 2 nâ€™est pas bonne. Vous lâ€™Ã©ditez et relancÃ© le buildâ€¦ et la <strong>PAF !</strong> vous vous rendez compte que Docker ne relance pas lâ€™Ã©tape 1 mais passe directement Ã  lâ€™Ã©tape 2 et 3, pourquoi ? parce quâ€™il a dÃ©jÃ  en mÃ©moire lâ€™Ã©tape 1 et sait quâ€™elle nâ€™a pas Ã©tÃ© touchÃ© donc il peut repartir de lÃ  et exÃ©cuter les Ã©tapes filles. A noter que les Ã©tapes sont sÃ©quentielles, elles dÃ©pendent toutes de leur â€œmÃ¨reâ€, Etape 3 dÃ©pend de Etape 2 qui elle mÃªme dÃ©pend dâ€™Etape 1. Docker ne peut donc pas relancer uniquement Lâ€™Ã©tape 2, elle est la mÃ¨re de lâ€™Ã©tape 3 et donc Docker nâ€™a aucun moyen de savoir si elle a Ã©tÃ© modifiÃ© ou pas.</p><h2 id="-les-instructions">ğŸ“ Les instructions</h2><p>On lâ€™a vu plus haut, un Dockerfile est composÃ© dâ€™instructions, dans les instructions courantes, on retrouve:</p><ul><li><code class="highlighter-rouge">FROM</code>: Câ€™est notre hÃ©ritage de base de lâ€™image</li><li><code class="highlighter-rouge">RUN</code>: On lance une commande dans le filesystem du conteneur</li><li><code class="highlighter-rouge">COPY</code>: Permet de copier des fichiers depuis la machine hÃ´te vers le conteneur</li><li><code class="highlighter-rouge">LABEL</code>: Notion â€œdâ€™Ã©tiquettesâ€ quâ€™on donne au conteneur, utile pour mettre qui est lâ€™auteur, le mainteneur, ou un mail de contact</li><li><code class="highlighter-rouge">ENV</code>: Affectation de variables dâ€™environnements</li><li><code class="highlighter-rouge">EXPOSE</code>: Permet dâ€™exposer des ports, par exemple dans le cas dâ€™un conteneur de serveur web, on exposera le port 80 et 443 afin de pouvoir accÃ©der au processus Nginx/Apache</li><li><code class="highlighter-rouge">WORKDIR</code>: Change le rÃ©pertoire de travail</li><li><code class="highlighter-rouge">ENTRYPOINT</code>: Lance un script dâ€™initialisation du conteneur</li><li><code class="highlighter-rouge">CMD</code>: Une fois le conteneur lancÃ©, CMD sera utilisÃ© comme commande par dÃ©faut pour lancer le conteneur (typiquement sur un conteneur <code class="highlighter-rouge">node</code> on pourrait avoir un <code class="highlighter-rouge">node start</code>)</li></ul><p>Ces instructions peuvent Ãªtre utilisÃ©es dans lâ€™ordre que vous voulez, Ã  lâ€™exception de certainesâ€¦ (bah oui, il y a toujours un truc bizarre qui se cacheâ€¦). Dans vos premiers Dockerfile vous utiliserez <strong>toujours</strong> lâ€™instruction <code class="highlighter-rouge">FROM</code> en premiÃ¨re. Tout simplement parce que votre image commence toujours Ã  partir dâ€™une autre image, vous avez la possibilitÃ© de crÃ©er votre propre image de â€œdÃ©partâ€. Câ€™est ce quâ€™on appelle les <code class="highlighter-rouge">base image</code>. Il nâ€™est pas du tout nÃ©cessaire de savoir crÃ©er des <code class="highlighter-rouge">base image</code> pour utiliser Docker mais pour les intÃ©ressÃ©s <a href="https://docs.docker.com/develop/develop-images/baseimages/">voici le lien</a>.</p><p>Mention spÃ©ciale aussi pour <code class="highlighter-rouge">CMD</code> et <code class="highlighter-rouge">ENTRYPOINT</code> qui sont souvent utilisÃ©es Ã  la fin du Dockerfile pour des soucis de lisibilitÃ©/comprÃ©hension et parce quâ€™elles dÃ©finissent le script/command Ã  lancÃ© une fois le conteneur â€œprÃªtâ€.</p><h2 id="ï¸-push-it-to-the-limit">ğŸ•Šï¸ Push it to the limit</h2><p><img src="https://media.giphy.com/media/owiooI9tn2hjy/giphy.gif" alt="" /></p><p>On a arrive Ã  construire nos images en locale, Ã  les lancer, lancer des commandes Ã  lâ€™intÃ©rieur de nos conteneurs etc.. cool ! mais comment fait-on pour les sauvegarder sur le hub ?</p><p>PremiÃ¨re Ã©tape, votre <code class="highlighter-rouge">Dockerfile</code> doit Ãªtre versionnÃ© avec github (ou autre) afin de garder une trace de votre image. La deuxiÃ¨me Ã©tape est toute simple, pour chaque version de votre image, vous allez lui appliquer un <code class="highlighter-rouge">tag</code> et lâ€™envoyer sur le hub docker.</p><p>Faisons un essai avec ce Dockerfile:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM debian:jessie
LABEL <span class="nv">maintainer</span><span class="o">=</span><span class="s2">"Thibaut BAYER&lt;bt0r&gt;"</span>
RUN <span class="nb">echo</span> <span class="s2">"Bienvenue sur votre premiÃ¨re image docker"</span>
COPY ./script.sh /root/script.sh
RUN <span class="nb">chmod </span>777 /root/script.sh
ENTRYPOINT <span class="o">[</span><span class="s2">"/root/script.sh"</span><span class="o">]</span>
</code></pre></div></div><p>Au mÃªme endroit que le Dockerfile, crÃ©ez un fichier nommÃ© <code class="highlighter-rouge">script.sh</code> avec ceci Ã  lâ€™intÃ©rieur</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="s2">"WOW ca marche"</span>
</code></pre></div></div><p>Lancons le build de lâ€™image :</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build .
</code></pre></div></div><p>Ce qui nous donne</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sending build context to Docker daemon  3.072kB
Step 1/6 : FROM debian:jessie
 <span class="nt">---</span><span class="o">&gt;</span> d69ffb5f6cbf
Step 2/6 : LABEL <span class="nv">maintainer</span><span class="o">=</span><span class="s2">"Thibaut BAYER&lt;bt0r&gt;"</span>
 <span class="nt">---</span><span class="o">&gt;</span> Using cache
 <span class="nt">---</span><span class="o">&gt;</span> 2ffcffa9a5a8
Step 3/6 : RUN <span class="nb">echo</span> <span class="s2">"Bienvenue sur votre premiÃ¨re image docker"</span>
 <span class="nt">---</span><span class="o">&gt;</span> Using cache
 <span class="nt">---</span><span class="o">&gt;</span> cb64dcad7887
Step 4/6 : COPY ./script.sh /root/script.sh
 <span class="nt">---</span><span class="o">&gt;</span> 70d8badd9532
Step 5/6 : RUN <span class="nb">chmod </span>777 /root/script.sh
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>a7f7f63d4490
Removing intermediate container a7f7f63d4490
 <span class="nt">---</span><span class="o">&gt;</span> 8df44389144c
Step 6/6 : ENTRYPOINT <span class="o">[</span><span class="s2">"/root/script.sh"</span><span class="o">]</span>
 <span class="nt">---</span><span class="o">&gt;</span> Running <span class="k">in </span>0d4194fc0f3e
Removing intermediate container 0d4194fc0f3e
 <span class="nt">---</span><span class="o">&gt;</span> 1faa94d56d33
Successfully built 1faa94d56d33

</code></pre></div></div><p>Vous noterez quâ€™une seule Ã©tape de mon Dockerfile crÃ©e quelque chose dans le conteneur, câ€™est lâ€™Ã©tape â€œCOPYâ€ qui copie un fichier depuis le systÃ¨me hÃ´te jusquâ€™au conteneur. Lâ€™instructions <code class="highlighter-rouge">RUN echo "Bienvenue ..."</code> ne sâ€™affiche que lors de lâ€™exÃ©cution du build, pas une fois lâ€™image crÃ©e/lancÃ©e.</p><p>Notre image est crÃ©e en local, on peut lâ€™exÃ©cuter en faisant <code class="highlighter-rouge">docker run 1faa94d56d33</code> (oÃ¹ <code class="highlighter-rouge">1faa94d56d33</code> correspond au dernier layer construit).</p><p><code class="highlighter-rouge">WOW ca marche</code> sâ€™affiche, gÃ©nial, sauf que voilÃ , notre image nâ€™a pas de version/nom du coup câ€™est un peu chiant dâ€™utiliser Ã  chaque fois le hash de celle-ci.</p><p>Et si on la tagguait ? Pour tagguer, il suffit dâ€™utiliser lâ€™option <code class="highlighter-rouge">-t</code> :</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker build <span class="nb">.</span> <span class="nt">-t</span> btor/wow

Sending build context to Docker daemon  3.072kB
Step 1/6 : FROM debian:jessie
 <span class="nt">---</span><span class="o">&gt;</span> d69ffb5f6cbf
Step 2/6 : LABEL <span class="nv">maintainer</span><span class="o">=</span><span class="s2">"Thibaut BAYER&lt;bt0r&gt;"</span>
 <span class="nt">---</span><span class="o">&gt;</span> Using cache
 <span class="nt">---</span><span class="o">&gt;</span> 2ffcffa9a5a8
Step 3/6 : RUN <span class="nb">echo</span> <span class="s2">"Bienvenue sur votre premiÃ¨re image docker"</span>
 <span class="nt">---</span><span class="o">&gt;</span> Using cache
 <span class="nt">---</span><span class="o">&gt;</span> cb64dcad7887
Step 4/6 : COPY ./script.sh /root/script.sh
 <span class="nt">---</span><span class="o">&gt;</span> Using cache
 <span class="nt">---</span><span class="o">&gt;</span> 70d8badd9532
Step 5/6 : RUN <span class="nb">chmod </span>777 /root/script.sh
 <span class="nt">---</span><span class="o">&gt;</span> Using cache
 <span class="nt">---</span><span class="o">&gt;</span> 8df44389144c
Step 6/6 : ENTRYPOINT <span class="o">[</span><span class="s2">"/root/script.sh"</span><span class="o">]</span>
 <span class="nt">---</span><span class="o">&gt;</span> Using cache
 <span class="nt">---</span><span class="o">&gt;</span> 1faa94d56d33
Successfully built 1faa94d56d33
Successfully tagged btor/wow:latest
</code></pre></div></div><p>On note ici que jâ€™ai utilisÃ© : <code class="highlighter-rouge">btor</code> comme nom de compte docker hub, <code class="highlighter-rouge">wow</code> comme repository et câ€™est tout, docker mâ€™a automatiquement attribuÃ© la version <code class="highlighter-rouge">latest</code>, ce qui veut dire que si je refait un build de cette mÃªme image ou dâ€™une image modifiÃ© avec le mÃªme tag, elle surchargera ma prÃ©cÃ©dente. Et oui jamy !</p><p><img src="https://media1.tenor.com/images/43d1951bb99d9223dbdc3146ef8b4f60/tenor.gif?itemid=11967093" alt="" /></p><p>Pour spÃ©cifier une version, on peut tout simplement ajouter <code class="highlighter-rouge">:v1</code> par exemple, ce qui donnerait</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nb">.</span> <span class="nt">-t</span> &lt;vous&gt;/wow:v1
</code></pre></div></div><p>La version peut sâ€™appeller de nâ€™importe quelle facon <code class="highlighter-rouge">10.1</code>, <code class="highlighter-rouge">v1</code>, <code class="highlighter-rouge">v1-alpha</code> â€¦</p><p>Notre image en v1 crÃ©e en local, il serait temps de lâ€™envoyer sur le docker hub en tapant <code class="highlighter-rouge">docker push &lt;vous&gt;/wow:v1</code> (pensez Ã  remplacer <code class="highlighter-rouge">&lt;vous&gt;</code> par votre nom de compte docker hub que ce soit pour vos builds ou vos push sinon vous nâ€™aurez pas les droits dâ€™envoyer sur un repository dont vous nâ€™Ãªtes pas le propriÃ©taire)</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push &lt;vous&gt;/wow:v1
The push refers to repository <span class="o">[</span>docker.io/&lt;vous&gt;/wow]
abd25ccbce1b: Pushed 
c70e7bc63ac2: Pushed 
790002cce4fd: Mounted from library/debian 
v1: digest: sha256:90717eefe2dedddfd65d818f88f1c75aa29b7f5c3aafc43dba2b0fca8656cf9b size: 943
</code></pre></div></div><p>Notre image est dÃ©sormais disponible sur le docker hub, elle est rÃ©utilisable par nâ€™importe qui (repository public) ! Top ! Maintenant Ã©ditons notre <code class="highlighter-rouge">script.sh</code> et remplaÃ§ons le <code class="highlighter-rouge">WOW ca marche</code> par <code class="highlighter-rouge">WOW c'est la v2 !</code> et taggons tout ca en v2</p><ul><li><code class="highlighter-rouge">vim script.sh</code> -&gt; Wow câ€™est la v2 !</li><li><code class="highlighter-rouge"> docker build . -t &lt;vous&gt;/wow:v2</code></li><li><code class="highlighter-rouge">docker push &lt;vous&gt;/wow:v2</code></li></ul><p>Une fois le push effectuÃ©, rendez vous sur votre compte docker hub. Vous devriez avoir 2 versions (<code class="highlighter-rouge">v1</code> et <code class="highlighter-rouge">v2</code>) dans votre repository <code class="highlighter-rouge">wow</code>.</p><p>Les deux versions peuvent Ãªtre rÃ©cupÃ©rÃ©es par nâ€™importe qui en faisant <code class="highlighter-rouge">docker pull &lt;vous&gt;/wow:v1</code> ou <code class="highlighter-rouge">docker run &lt;vous&gt;/wow:v2</code>, si lâ€™image nâ€™existe pas en local, docker va rechercher sur docker hub et va automatiquement tÃ©lÃ©charger lâ€™image.</p><p>Et si on testait ce fonctionnement en local ? :D</p><ul><li>Listez vos images locales en tapant <code class="highlighter-rouge">docker images &lt;vous&gt;/wow</code></li><li>Supprimez vos 2 versions locale <code class="highlighter-rouge">v1</code> et <code class="highlighter-rouge">v2</code> en faisant ` docker rmi â€“force 1faa94d56d33 1faa94d56d33` (avec vos hash dâ€™images)</li></ul><p><strong>docker images</strong> permet de lister les images disponibles en local, tandis que <strong>docker rmi</strong> supprime les images (<code class="highlighter-rouge">rmi</code> pour remove images).</p><p>Les images Ã©tant supprimÃ©es, testons de rÃ©cupÃ©rer les images que vous avez publiez :</p><ul><li><code class="highlighter-rouge">docker run &lt;vous&gt;/wow:v1</code> =&gt; WOW ca marche</li><li><code class="highlighter-rouge">docker run &lt;vous&gt;/wow:v2</code> =&gt; WOW câ€™est la v2 !</li></ul><p>Dans les deux cas, docker nous informe bien que lâ€™image nâ€™est pas disponible en local <code class="highlighter-rouge">Unable to find image '&lt;vous&gt;/wow:v1' locally</code>. Vous pouvez dâ€™ailleurs essayer avec les images que jâ€™ai moi mÃªme postÃ© sur le hub sans remplacer par votre nom dâ€™utilisateur : <code class="highlighter-rouge">docker run btor/wow:v1</code> vous devriez avoir le mÃªme rÃ©sultat mais docker retÃ©lÃ©chargera lâ€™image (vu que pour lui elle est diffÃ©rente de la votre).</p><h1 id="conclusion">Conclusion</h1><p>Vous avez dÃ©sormais les notions de bases de docker, vous savez comment docker fonctionne, comment rÃ©cupÃ©rer/stoper/lancer/crÃ©er/pousser une image. Si vous avez aimÃ© cet article ou que vous dÃ©sirez avoir plus dâ€™informations (voir mÃªme dâ€™autres articles dans la mÃªme veine, <code class="highlighter-rouge">docker-compose</code>, docker avancÃ©, <code class="highlighter-rouge">kubernetes</code> etc..) faites le moi savoir :D</p></div><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://btor.fr/2019/07/03/docker-bases-tuto/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Docker, les bases+https://btor.fr/2019/07/03/docker-bases-tuto/+by+Thibaut BAYER" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://plus.google.com/share?url=https://btor.fr/2019/07/03/docker-bases-tuto/" target="_blank"><i class="fa fa-google-plus"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Docker, les bases&summary=&url=https://btor.fr/2019/07/03/docker-bases-tuto/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.stumbleupon.com/badge/?url=https://btor.fr/2019/07/03/docker-bases-tuto/" target="_blank"><i class="fa fa-stumbleupon"></i></a></li><li><a href="https://www.reddit.com/submit?url=https://btor.fr/2019/07/03/docker-bases-tuto/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li><li><a href="https://www.tumblr.com/share/link?url=https://btor.fr/2019/07/03/docker-bases-tuto/" target="_blank"><i class="fa fa-tumblr"></i></a></li><li><a href="https://www.pinterest.com/pin/create/link/?description=&media=https://btor.fr/assets/images/docker-bases/main.png&url=https://btor.fr/2019/07/03/docker-bases-tuto/" target="_blank"><i class="fa fa-pinterest"></i></a></li></ul></div></div><div class="section-padding--none"><div class="grid"><hr class="sep"/></div></div><div class="section-padding"><div class="grid-small"> <span class="post__author">PostÃ© par <a href="http://btor.fr" title="More By Thibaut BAYER">Thibaut BAYER</a></span><p class="post__bio">PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech !</p></div></div></article></div><section class="related section-padding"><div class="grid-xlarge"><h2 class="related__title"></h2><div class="related__container"><article class="related__post"> <a class="related__link" href="https://btor.fr/2019/07/03/docker-bases-tuto/"><figure class="related__img"> <img src="/assets/images/docker-bases/main.png" alt="Docker, les bases"/></figure><div><h2 class="related__text">Docker, les bases</h2></div></a></article></div></div></section></main><footer class="footer section-padding"><div class="grid"><div class="subscribe" id="subscribe"><div class="subscribe__container"> <span class="subscribe__title">Restons en contact</span><ul class="footer__social"><li><a href="https://twitter.com/biiitor" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://www.instagram.com/btor.fr/" target="_blank"><i class="fa fa-instagram"></i></a></li><li><a href="https://www.linkedin.com/in/thibaut-bayer//" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://github.com/bt0r" target="_blank"><i class="fa fa-github"></i></a></li><li><a href="https://twitch.tv/bt0r" target="_blank"><i class="fa fa-twitch"></i></a></li></ul></div></div><hr class="sep--white"/><div class="footer__container"><p>CatÃ©gories</p><ul class="footer__tags"><li><a class="footer__link" href="/tag/materiel">Materiel</a></li><li><a class="footer__link" href="/tag/test">Test</a></li><li><a class="footer__link" href="/tag/tutorial">Tutorial</a></li><li><a class="footer__link" href="/tag/photos--vido">Photos & VidÃ©o</a></li><li><a class="footer__link" href="/tag/bon-plans">Bon Plans</a></li></ul></div></div></footer><section class="contact popup"><div class="popup__close"><div class="popup__exit"></div></div><div class="contact__container popup__container"><div class="contact__img"><figure class="absolute-bg" style="background-image: url(/assets/images/logo/logo.dark.small.png);"></figure></div><div class="contact__content"><div class="contact__mast section-padding--half"><div class="grid"><h2>Contact</h2></div></div><div class="section-padding--none"><hr class="sep"/></div><div class="contact__form section-padding--half"><div class="grid-xlarge"> <form id="form" class="form" action="https://formcarry.com/s/HkIo0nMb7" method="POST"><div class="form__subcontainer"><div> <label for="form-first-name">First Name</label> <input type="text" name="first-name" id="form-first-name" required></div><div> <label for="form-last-name">Last Name</label> <input type="text" name="last-name" id="form-last-name" required></div></div><div> <label for="form-email">E-Mail</label> <input type="email" name="email" id="form-email" required></div><div> <label for="form-message">Message</label> <textarea name="message" id="form-message" rows="3"></textarea></div><div class="form__submit"><div class="form__btn"> <input type="submit" value="Send"></div></div><p class="form__message"></p></form></div></div></div></div></section><script src="/assets/js/app.min.js"></script></body></html>
  