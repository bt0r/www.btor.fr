<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Docker avancé | btor.fr</title><meta name="description" content="Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta itemprop="name" content="Thibaut BAYER"><meta itemprop="description" content="Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta itemprop="image" content="https://btor.fr/assets/images/docker-pratique-outils/main.png"><meta property="og:url" content="https://btor.fr/2019/12/01/docker-avance/"><meta property="og:type" content="website"><meta property="og:title" content="Docker avancé | btor.fr"><meta property="og:site_name" content="btor.fr"><meta property="og:description" content="Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta property="og:image" content="https://btor.fr/assets/images/docker-pratique-outils/main.png"><meta name="twitter:url" content="https://btor.fr/2019/12/01/docker-avance/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Docker avancé | btor.fr"><meta name="twitter:site" content="btor.fr"><meta name="twitter:description" content="Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta name="twitter:creator" content="@biiitor"><meta property="twitter:image" content="https://btor.fr/assets/images/docker-pratique-outils/main.png"><link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"><link rel="stylesheet" href="/assets/css/app.min.css"><link rel="alternate" type="application/rss+xml" title="btor.fr" href="/feed.xml"><link rel="canonical" href="/2019/12/01/docker-avance/"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-153641953-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-153641953-1'); </script></head><body id="docker-avancé" class="post-layout"><header class="header"> <a class="header__title" href="https://btor.fr/"><img width="75" src="/assets/images/logo/logo.dark.small.png"/></a><nav><ul class="header__list"><li><a href="/qui-suis-je">❓ Qui suis-je</a></li><li><a href="/help">❤️ Me soutenir</a></li></ul></nav></header><main class="💈"><div class="post"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><div class="post__header section-padding--double"><div class="grid-small"><h2 itemprop="name headline">Docker avancé</h2><time class="post__date" datetime="2019-12-01T00:00:00-06:00" itemprop="datePublished">01/12/2019</time></div></div><div class="post__img"><div><figure class="absolute-bg" style="background-image: url('/assets/images/docker-pratique-outils/main.png');"></figure></div></div><div class="post__content section-padding"><div class="grid"><div id="markdown" itemprop="articleBody"><p>Dans mon dernier article je vous expliquais les bases de docker, partons du principe que vous avez donc ces bases (docker push/pull/exec/ps/kill…) et que vous désirez aller un peu plus loin avec Docker. Il vous manque surement énormément d’informations pour vraiment utiliser Docker, dans cet article j’y répondrais et vous aurez de quoi avoir votre première stack docker fonctionnelle (promis ca ne sera pas long, seulement 223 pages éhéh).</p><p>Commençons par nous poser la bonne question, pourquoi utiliser Docker ? <em>Il parait que c’est cool</em></p><p>Dans quel contexte ? <em>Ma stack de dev ? en production ?</em></p><p>Répond t-il a tout nos besoins ? <em>Surement pas</em></p><p>La conteneurisation va nous permettre de lancer des processus dans un environnement cloisonné (oui je sais, je me répète). Autrement dit, si vous avez l’habitude d’installer votre stack local à la main, à base de <code class="highlighter-rouge">apt install apache2 ... </code> ou autre, vous ne voyez surement pas l’intérêt de passer sur docker et pourtant ! dans énormément de cas docker peut vous aider. J’ai eu récemment le cas au travail où un développeur mobile ne connaissait pas Docker (ou juste de nom) et ne l’utilisait pas parcequ’il en voyait pas forcément l’utilité. En ayant pris connaissance des fonctionnalités apportées par Docker ainsi qu’une petite présentation bien ficelée ( #JaiUnMelonHorsNorme ), il a fini par trouvé Docker indispensable.</p><p>Voici quelques exemples d’utilisations de docker :</p><ul><li>En tant que développeur web, vous avez votre bon vieux LAMP (Linux, Apache, Mysql, Php) classique, c’est cool mais comment font les nouveaux dévs quand ils arrivent dans votre team ? Ils réinstallent la stack complète à la main ? Quid du développeur qui utilise mac alors que toi tu utilises Windows ? C’est à ce moment là que Docker est utile, un fichier de configuration pour tout le monde et en 2 clicks, la stack est montée.</li><li>En tant que devsOps, tu es souvent amené à alterner entre Python et Go, puis parfois, tu as besoin de gérer plusieurs versions de python, de go, au sein de la même machine. Pourquoi s’embêter avec une installation manuelle quand tu peux juste faire un <code class="highlighter-rouge">docker run golang:1.11.11</code> <code class="highlighter-rouge">docker run golang:1.12.6</code> <code class="highlighter-rouge">docker run python:2.7-stretch</code> <code class="highlighter-rouge">docker run python:3.7.3-stretch</code> ?</li><li>En tant que pentester vous utilisez différents outils d’intrusion et vous travaillez sur une faille PhpMyAdmin, comment tester facilement votre exploit sur différentes versions ? DOCKERRRRRRR</li></ul><p>Des exemples comme ceux-là il en existe un paquet, le plus important n’est pas d’utiliser docker parce que c’est sexy mais d’arriver à comprendre ce qu’il va vous apporter.</p><h1 id="️-docker-en-stack-de-développement">⚙️ Docker en stack de développement</h1><p>Maintenant que nous avons les différents cas d’utilisation, prenons un des cas qui m’a concerné et qui est surement LE cas par excellence de docker : La stack de développement</p><p>Historiquement, on téléchargeait notre petit LAMP, MAMP, WAMP et on développait dans notre coin pépouze. Ca marche mais c’est vite chiant, on peut souvent avoir un soucis isolé d’un autre dév parcequ’il n’est pas sur le même système d’exploitation, n’a pas mis la même configuration etc.. Grâce à Docker, on va avoir la même configuration, cross-platform et surtout on aura tous les mêmes erreurs de merde quand ça plantera ET CA C’EST COOL ! @@LUL</p><p><img src="https://media.giphy.com/media/3oxRmGXbquXKz6DNPq/giphy.gif" alt="" /></p><h2 id="️-le-besoin">✍️ Le besoin</h2><p>On va prendre en compte une stack de développement web classique, un bon vieux LAMP ! On a donc besoin :</p><ul><li>D’un serveur web, apache ou nginx</li><li>D’un process PHP-FPM</li><li>D’une base MySQL, PostgreSQL ou autre</li></ul><p>La première chose à faire dans ce cas là est de rechercher si les technos sont disponibles sur Docker (via le docker hub).</p><p>Après recherche, on trouve donc :</p><ul><li><a href="https://hub.docker.com/_/php">PHP</a></li><li><a href="https://hub.docker.com/_/mysql">MySQL</a></li><li><a href="https://hub.docker.com/_/nginx">NginX</a></li></ul><p>Bingo, on a déjà de quoi faire pour créer notre stack. @@HEY</p><h2 id="️-la-pratique">🛠️ La pratique</h2><p>Je vous l’avais expliqué dans l’article précédent, pour lancer un conteneur on utilise <code class="highlighter-rouge">docker run</code> oui mais voilà, c’est vrai mais je vous ai légèrement menti…</p><p><img src="https://media.giphy.com/media/2emoe1XUg23rW/giphy.gif" alt="" /></p><p><code class="highlighter-rouge">docker run</code> récupère et lance une image docker, c’est vrai… mais imaginez si on devait faire ça pour tous les processus que vous utilisez ? Ça serait vite chiant ! <code class="highlighter-rouge">docker run php &amp;&amp; docker run mysql &amp;&amp; docker run nginx</code> etc… Puis comme je vous l’ai dit, les conteneurs ont une durée de vie limité, on les lance, ils s’arrêtent et la donnée à l’intérieur de celui-ci est effacée. Comment faire pour utiliser une base de donnée ? ou même juste votre code source pour qu’il soit interprété par PHP ?</p><p>En réalité, Docker ne se limite pas à 4 commandes push/run/pull/exec, vous pouvez gérer bien plus de choses comme le réseau entre vos conteneurs, monter des volumes de fichiers, gérer vos entrées /etc/hosts etc..</p><p>C’est exactement la même chose que la configuration d’une machine virtuelle sauf qu’on enlève l’aspect "matériel", on ne gère pas la mémoire qu’on attribue à notre conteneur, ni même son espace disque. Par contre, on peut gérer l’espace disque ou la mémoire qu’on alloue à la machine virtuelle docker (dans le cas d’un DockerForMac par exemple)</p><p><img src="/assets/images/docker-pratique-outils/settings.png" alt="" /></p><p>Commençons par la création du conteneur nginx, notre process nginx va avoir besoin d’une configuration de base pour fonctionner (bah ouai, il faut bien qu’il sache où est notre code source et comment il doit l’interpréter)</p><p><em>Pour faciliter la relecture et la compréhension, tous les extraits de code ou de configuration sont disponibles sur <a href="https://github.com/bt0r/docker-article">ce repo github</a></em></p><p>Revenons sur l’image docker que j’ai crée:</p><div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> nginx:1.17.1-alpine</span>

<span class="k">RUN </span><span class="nb">mkdir</span> <span class="nt">-p</span> /var/www/btor.fr

<span class="k">COPY</span><span class="s"> ./config/btor.fr /etc/nginx/sites-available/</span>

<span class="k">WORKDIR</span><span class="s"> /var/www/btor.fr</span>
</code></pre></div></div><p><em>Je ne reviens pas sur le détail du fichier de configuration nginx, c’est un fichier basique</em></p><p>Avec cette image, on voit bien qu’il n’y a rien dedans, on récupère juste nginx, on copie un fichier de configuration, on crée le répertoire <code class="highlighter-rouge">/var/www/btor.fr</code> et on le définit comme répertoire par défaut. Parfait, mais comment dire à nginx d’afficher notre page web ?</p><p>La solution est de monter un volume pour que ces fichiers soient non pas copiés mon montés à la volée.</p><ul><li>Rendez vous dans votre répertoire <code class="highlighter-rouge">docker/nginx</code></li><li>Taper <code class="highlighter-rouge">docker build . -t btor/nginx</code></li><li>Puis <code class="highlighter-rouge">docker run -d -v ~/www/docker-article/web:/var/www/btor.fr btor/nginx</code> (attention au chemin du répertoire web)</li></ul><p>Votre conteneur devrait se lancer et afficher un hash (qui correspond à l’ID du conteneur). Vérifions avec un <code class="highlighter-rouge">docker ps</code> :</p><div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
e4c925076a14        btor/nginx          \"nginx -g 'daemon of…\"   4 seconds ago       Up 3 seconds        80/tcp                   relaxed_wescoff
</code></pre></div></div><p>Notre conteneur nginx fonctionne bien, le volume à l’air d’avoir été pris en compte. On va donc le vérifier :</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>btor@dev<span class="nv">$ </span>docker <span class="nb">exec</span> &lt;containerID&gt; <span class="nb">ls
</span>index.php
</code></pre></div></div><p>Bingo, le volume a bien été monté et les fichiers disponibles dans <code class="highlighter-rouge">/web</code> sont bien dans le répertoire <code class="highlighter-rouge">/var/www/btor.fr</code> du conteneur.</p><p>Maintenant que notre conteneur a bien les bons fichiers, essayons d’y accéder en HTTP. Première étape:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>btor@deb<span class="nv">$ </span>docker <span class="nb">exec</span> &lt;container_id&gt;  wget localhost <span class="nt">-O-</span>
...
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;
...
</code></pre></div></div><p>Notre conteneur nous répond bien avec la page par défaut de NGINX mais pas de php, logique ! nous avons monté un volume de fichier mais aucun conteneur PHP n’existe.</p><p>Relions maintenant le conteneur nginx et PHP.</p><pre><code class="language-Dockerfile">FROM php:7.3.6-fpm-alpine

WORKDIR /var/www/btor.fr
</code></pre><p>Ports</p><p>Docker-compose</p></div><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://btor.fr/2019/12/01/docker-avance/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Docker avancé+https://btor.fr/2019/12/01/docker-avance/+by+Thibaut BAYER" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://plus.google.com/share?url=https://btor.fr/2019/12/01/docker-avance/" target="_blank"><i class="fa fa-google-plus"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Docker avancé&summary=&url=https://btor.fr/2019/12/01/docker-avance/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.stumbleupon.com/badge/?url=https://btor.fr/2019/12/01/docker-avance/" target="_blank"><i class="fa fa-stumbleupon"></i></a></li><li><a href="https://www.reddit.com/submit?url=https://btor.fr/2019/12/01/docker-avance/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li><li><a href="https://www.tumblr.com/share/link?url=https://btor.fr/2019/12/01/docker-avance/" target="_blank"><i class="fa fa-tumblr"></i></a></li><li><a href="https://www.pinterest.com/pin/create/link/?description=&media=https://btor.fr/assets/images/docker-pratique-outils/main.png&url=https://btor.fr/2019/12/01/docker-avance/" target="_blank"><i class="fa fa-pinterest"></i></a></li></ul></div></div><div class="section-padding--none"><div class="grid"><hr class="sep"/></div></div><div class="section-padding"><div class="grid-small"> <span class="post__author">Posté par <a href="http://btor.fr" title="More By Thibaut BAYER">Thibaut BAYER</a></span><p class="post__bio">Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech !</p></div></div></article></div><section class="related section-padding"><div class="grid-xlarge"><h2 class="related__title"></h2><div class="related__container"><article class="related__post"> <a class="related__link" href="https://btor.fr/2019/12/01/docker-avance/"><figure class="related__img"> <img src="/assets/images/docker-pratique-outils/main.png" alt="Docker avancé"/></figure><div><h2 class="related__text">Docker avancé</h2></div></a></article><article class="related__post"> <a class="related__link" href="https://btor.fr/2019/07/03/docker-bases-tuto/"><figure class="related__img"> <img src="/assets/images/docker-bases/main.png" alt="Docker, les bases"/></figure><div><h2 class="related__text">Docker, les bases</h2></div></a></article></div></div></section></main><footer class="footer section-padding"><div class="grid"><div class="subscribe" id="subscribe"><div class="subscribe__container"> <span class="subscribe__title">Restons en contact</span><ul class="footer__social"><li><a href="https://twitter.com/biiitor" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://www.instagram.com/btor.fr/" target="_blank"><i class="fa fa-instagram"></i></a></li><li><a href="https://www.linkedin.com/in/thibaut-bayer//" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://github.com/bt0r" target="_blank"><i class="fa fa-github"></i></a></li><li><a href="https://twitch.tv/bt0r" target="_blank"><i class="fa fa-twitch"></i></a></li></ul></div></div><hr class="sep--white"/><div class="footer__container"><p>Catégories</p><ul class="footer__tags"><li><a class="footer__link" href="/tag/materiel">Materiel</a></li><li><a class="footer__link" href="/tag/test">Test</a></li><li><a class="footer__link" href="/tag/infrastructure">Infrastructure</a></li><li><a class="footer__link" href="/tag/tutorial">Tutorial</a></li><li><a class="footer__link" href="/tag/photos--vido">Photos & Vidéo</a></li></ul></div></div></footer><section class="contact popup"><div class="popup__close"><div class="popup__exit"></div></div><div class="contact__container popup__container"><div class="contact__img"><figure class="absolute-bg" style="background-image: url(/assets/images/logo/logo.dark.small.png);"></figure></div><div class="contact__content"><div class="contact__mast section-padding--half"><div class="grid"><h2>Contact</h2></div></div><div class="section-padding--none"><hr class="sep"/></div><div class="contact__form section-padding--half"><div class="grid-xlarge"> <form id="form" class="form" action="https://formcarry.com/s/HkIo0nMb7" method="POST"><div class="form__subcontainer"><div> <label for="form-first-name">First Name</label> <input type="text" name="first-name" id="form-first-name" required></div><div> <label for="form-last-name">Last Name</label> <input type="text" name="last-name" id="form-last-name" required></div></div><div> <label for="form-email">E-Mail</label> <input type="email" name="email" id="form-email" required></div><div> <label for="form-message">Message</label> <textarea name="message" id="form-message" rows="3"></textarea></div><div class="form__submit"><div class="form__btn"> <input type="submit" value="Send"></div></div><p class="form__message"></p></form></div></div></div></div></section><script src="/assets/js/app.min.js"></script></body></html>
  