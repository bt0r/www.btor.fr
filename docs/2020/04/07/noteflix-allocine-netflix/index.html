<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Noteflix: Une extension firefox pour voir les notes Allociné sur Netflix | btor.fr</title><meta name="description" content="Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta itemprop="name" content="Thibaut BAYER"><meta itemprop="description" content="Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta itemprop="image" content="https://btor.fr/assets/images/noteflix/main.png"><meta property="og:url" content="https://btor.fr/2020/04/07/noteflix-allocine-netflix/"><meta property="og:type" content="website"><meta property="og:title" content="Noteflix: Une extension firefox pour voir les notes Allociné sur Netflix | btor.fr"><meta property="og:site_name" content="btor.fr"><meta property="og:description" content="Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta property="og:image" content="https://btor.fr/assets/images/noteflix/main.png"><meta name="twitter:url" content="https://btor.fr/2020/04/07/noteflix-allocine-netflix/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Noteflix: Une extension firefox pour voir les notes Allociné sur Netflix | btor.fr"><meta name="twitter:site" content="btor.fr"><meta name="twitter:description" content="Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta name="twitter:creator" content="@biiitor"><meta property="twitter:image" content="https://btor.fr/assets/images/noteflix/main.png"><link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"><link rel="stylesheet" href="/assets/css/app.min.css"><link rel="alternate" type="application/rss+xml" title="btor.fr" href="/feed.xml"><link rel="canonical" href="/2020/04/07/noteflix-allocine-netflix/"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-153641953-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-153641953-1'); </script></head><body id="noteflix-une-extension-firefox-pour-voir-les-notes-allociné-sur-netflix" class="post-layout"><header class="header"> <a class="header__title" href="https://btor.fr/"><img width="75" src="/assets/images/logo/logo.dark.small.png"/></a><nav><ul class="header__list"><li><a href="/qui-suis-je">❓ Qui suis-je</a></li></ul></nav></header><main class="💈"><div class="post"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><div class="post__header section-padding--double"><div class="grid-small"><h2 itemprop="name headline">Noteflix: Une extension firefox pour voir les notes Allociné sur Netflix</h2><time class="post__date" datetime="2020-04-07T00:00:00-05:00" itemprop="datePublished">07/04/2020</time></div></div><div class="post__img"><div><figure class="absolute-bg" style="background-image: url('/assets/images/noteflix/main.png');"></figure></div></div><div class="post__content section-padding"><div class="grid"><div id="markdown" itemprop="articleBody"><p>Comme bon nombre d’entre vous, je profite du confinement pour avancer sur des projets personnels. Jeudi dernier, après avoir passé près de 4h à coder sur un projet personnel en react-native, je me suis dis :</p><blockquote><p> Et si je me mettais une petite série Netflix ?</p></blockquote><p>Ni une, ni deux, j’ouvre Netflix et commence à chercher LA série qui va me tenir en haleine sur les prochains jours. Problème, il m’arrive souvent de tomber sur des séries un peu naze comme <a href="http://www.allocine.fr/series/ficheserie_gen_cserie=24219.html">Marianne</a>, cette bouse comiquo-horrifique @@NO.</p><p>C’est à ce moment précis qu’il me vint à l’esprit une idée de génie</p><blockquote><p>Ça pourrait être pas mal d’avoir un meilleur indicateur de notes des films et séries netflix !</p></blockquote><p><img src="https://media.giphy.com/media/l0LEIXSRRuv9QQIRNI/giphy.gif" alt="" class="center-image" /> <em>21h, la décision est prise: Je me lance dans le développement d’une extension firefox pour récupérer les notes <a href="https://allocine.fr">allociné</a> afin de les intégrer à Netflix.</em></p><h1 id="les-premiers-balbutiements">Les premiers balbutiements</h1><p>Quand on commence un nouveau projet, on a toujours envie de commencer fort, d’utiliser la dernière techno à la mode, de ne pas réfléchir et “pisser du code” vite, très vite !</p><p>C’est pourtant tout ce qu’il ne faut pas faire. Le plus dur c’est justement de bien réfléchir aux choix techniques, aux risques, à pondérer chaque technos pour ses avantages et inconvénients etc..</p><p><strong>BREF</strong>, c’est chiant mais on a souvent pas le choix !</p><p>…</p><p><strong>SAUF</strong> quand tu codes une extension Firefox pour un side project dont tu te contrefous de la dernière techno à la mode puisque de toute facon tu feras au mieux du Typescript transpilé pour aller dans un environement cloisonné. @@LUL</p><p>Je n’avais donc pas beaucoup de questions à me poser, je savais que j’allais partir sur du Javascript ou au mieux du Typescript et que le code ne serait pas très complexe étant donné que ça serait qu’un simple appel ajax à l’API d’Allociné. Du moins, c’est ce que je croyais @@SAD</p><p>J’avais déjà réalisé une petite extension Firefox sans l’avoir publié sur le store de Mozilla, je partais donc avec un léger avantage de ce côté là. Par contre, je n’avais jamais regardé de près comment fonctionne le site d’allociné. Ce n’est pas un site que je regarde régulièrement mais c’est en général le premier que je vais voir quand je recherche une information sur un film ou une série (d’ou mon choix de l’intégrer à Netflix)</p><p>J’ai donc commencé ce side-project en me faisant un petit repository GitHub avec un bootstrap d’extension pour juste faire mes premiers crash-tests. Avant de m’attaquer à Netflix, je voulais m’assurer qu’il était possible de récupérer les notes de films/séries depuis l’API d’allocine.</p><p>Je pars convaincu, serein, frais comme un gardon, bref j’suis chaud @@PROUD</p><p>J’arrive sur le site d’allociné et je commence à investiguer un peu ce qu’il se passe sur le site:</p><ul><li>F12, onglet réseaux, est ce qu’il y a des call XHR au chargement de la page ? Nope ! @@NO</li><li>Je regarde les différents input afin de voir si certains marchent en Ajax, bingo ! celui de la barre de recherche fait un call ajax @@HEY</li></ul><p><img src="/assets/images/noteflix/search_allocine.png" alt="Barre de recherche Allociné" class="center-image" /></p><p>Voyons un peu ce que ça donne en recherchant <a href="http://www.allocine.fr/_/autocomplete/breaking%20bad">Breaking bad</a>:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"error"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="s2">"message"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="s2">"results"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"entity_type"</span><span class="p">:</span><span class="s2">"series"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"entity_id"</span><span class="p">:</span><span class="s2">"3517"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"gid"</span><span class="p">:</span><span class="s2">"series.series._.3517"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"label"</span><span class="p">:</span><span class="s2">"Breaking Bad"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"facet"</span><span class="p">:</span><span class="s2">"series"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"original_label"</span><span class="p">:</span><span class="s2">"Breaking Bad"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"text_search_data"</span><span class="p">:[</span><span class="w">
        </span><span class="s2">"BrBa"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="s2">"status"</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="w">
      </span><span class="s2">"viewcount"</span><span class="p">:</span><span class="mi">975962</span><span class="p">,</span><span class="w">
      </span><span class="s2">"irankpopular"</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="w">
      </span><span class="s2">"browsable"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="s2">"last_release"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="s2">"data"</span><span class="p">:{</span><span class="w">
        </span><span class="s2">"id"</span><span class="p">:</span><span class="mi">3517</span><span class="p">,</span><span class="w">
        </span><span class="s2">"year"</span><span class="p">:</span><span class="s2">"2008"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"is_program"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="s2">"poster_path"</span><span class="p">:</span><span class="s2">"</span><span class="se">\/</span><span class="s2">pictures</span><span class="se">\/</span><span class="s2">19</span><span class="se">\/</span><span class="s2">06</span><span class="se">\/</span><span class="s2">18</span><span class="se">\/</span><span class="s2">12</span><span class="se">\/</span><span class="s2">11</span><span class="se">\/</span><span class="s2">3956503.jpg"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"creator_name"</span><span class="p">:[</span><span class="w">
          </span><span class="s2">"Vince Gilligan"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"showrunner_name"</span><span class="p">:[</span><span class="w">
          </span><span class="s2">"Vince Gilligan"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"thumbnail"</span><span class="p">:</span><span class="s2">"http:</span><span class="se">\/\/</span><span class="s2">fr.web.img6.acsta.net</span><span class="se">\/</span><span class="s2">c_75_100</span><span class="se">\/</span><span class="s2">pictures</span><span class="se">\/</span><span class="s2">19</span><span class="se">\/</span><span class="s2">06</span><span class="se">\/</span><span class="s2">18</span><span class="se">\/</span><span class="s2">12</span><span class="se">\/</span><span class="s2">11</span><span class="se">\/</span><span class="s2">3956503.jpg"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"scores"</span><span class="p">:{</span><span class="w">
        </span><span class="s2">"rating_score"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="w">
        </span><span class="s2">"weekly_rank_score"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="s2">"all_time_rank_score"</span><span class="p">:</span><span class="mi">5</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"genres"</span><span class="p">:[</span><span class="w">
        </span><span class="s2">"Drama"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="s2">"tags"</span><span class="p">:[</span><span class="w">
        </span><span class="s2">"Series.Type.Series"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Series.Status.Ended"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Info.Genre.Drama"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Format.Color.Color"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="s2">"last_updated_at"</span><span class="p">:</span><span class="s2">"2020-03-27T08:16:53.320000+01:00"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"index"</span><span class="p">:</span><span class="s2">"search_ac_20200408070105"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="s2">"search"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"series.series._.3517"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"score"</span><span class="p">:</span><span class="mf">23897.488</span><span class="p">,</span><span class="w">
      </span><span class="s2">"sponsored"</span><span class="p">:</span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>On remarque que le format de réponse est assez light, 3 champs dont un qui nous intéresse <code class="highlighter-rouge">results</code>, qui contient les objets répondant à notre recherche. Ces objets peuvent être des films, séries ou des personnalités. C’est déjà une première étape à garder en tête vu qu’on ne voudra que ce qui est films ou séries.</p><p>On y trouve aussi un objet <code class="highlighter-rouge">scores</code>, intéressant !</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"scores"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"rating_score"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="w">
        </span><span class="s2">"weekly_rank_score"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="s2">"all_time_rank_score"</span><span class="p">:</span><span class="mi">5</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>Parfait, je regarde donc à quoi correspondent ces scores, voir si ils correspondent à ce que je recherche (en l’occurence, les notes des spectateurs).</p><p><img src="/assets/images/noteflix/scores_allocine.png" alt="Score allociné" class="center-image" /></p><p>Jeanne @@JEANNE ! Au secours ! D’où proviennent ces scores ? J’ai beau tester avec 2 ou 3 autres films/séries, aucune corrélation n’est envisageable.</p><p>Je continue donc mon investigation en fouinant sur le site mais rien n’y fait, je ne trouve aucune donnée viable via une API. Je décide donc de regarder un peu sur google et je tombe sur le blog d’un certains <a href="https://wiki.gromez.fr/dev/api/allocine_v3">Gromez qui parle de l’API d’Allociné</a>.</p><p>L’article est vieux (2013) mais très intéressant, il parle des différents endpoint qu’il a pu trouver en regardant le comportement de l’app mobile via un <a href="https://fr.wikipedia.org/wiki/Analyseur_de_paquets">analyseur de paquet</a>.</p><p>Malheureusement, l’article étant daté, les liens et token fournis le sont aussi. Je décide donc à mon tour de regarder comment se comporte l’application mobile.</p><h1 id="analyse-de-paquet">Analyse de paquet</h1><p>En général quand je cherche à avoir des infos sur une API, je regarde comment l’application mobile fonctionne. Pour ce faire, je me charge de capturer les paquets IP qui sortent de mon téléphone et je regarde ce qui concerne l’application.</p><p>Auparavant j’utilisais BitShark, une application de capture de flux IP qui me permettait de générer un fichier .pcap que j’ouvrais ensuite dans Wireshark. Ca marche mais c’est vite chiant de devoir transférer les .pcap sur un ordinateur pour ensuite faire l’analyse. De plus, cette application ne semble plus être dans le store Android.</p><p>En fouinant le store je tombe sur <a href="https://play.google.com/store/apps/details?id=com.egorovandreyrm.pcapremote&amp;hl=fr">PCAPRemote</a> qui a un fonctionnement très basique: il permet de faire de la capture de packet en utilisant sshDump.</p><blockquote><p> SSHDump ? Kézako ?</p></blockquote><p>Sshdump va nous permettre de capturer des paquets non pas depuis notre propre machine mais depuis une machine hôte, en l’occurence mon téléphone. Le téléphone fait office de serveur et mon wireshark de client, fini les envoies de fichier .pcap d’un device à un autre @@SLT !</p><p><img src="/assets/images/noteflix/pcap_remote.png" alt="PCAPRemote" class="center-image" /></p><p>L’interface est assez simple, le bouton “play” permet de lancer une capture global du smartphone tandis que le bouton “Play 1” permet de choisir une application spécifique.  Pratique pour éviter de filtrer à posteriori sur Wireshark !</p><p>Il suffit ensuite de renseigner l’ip et port de l’hôte (le téléphone) sur wireshark en utilisant l’option <code class="highlighter-rouge">SSH remote capture: sshdump</code></p><p><img src="/assets/images/noteflix/wireshark_sshdump.png" alt="Wireshark SSHDump" class="center-image" /></p><p>Wireshark reçoit désormais les trames IP, j’en profite pour filtrer sur le protocole HTTP afin d’éviter d’être flooder de requêtes inutiles. Pendant que mon Wireshark tourne, je manipule un peu l’application allociné afin du générer du traffic, je recherche, click sur des films, change de pages etc.</p><p>Et qu’est ce qui apparait dans Wireshark ? @@LUL</p><p><img src="/assets/images/noteflix/search_wireshark.png" alt="PCAPRemote" class="center-image" /></p><p>C’est exactement le même endpoint qui était utilisé dans la barre de recherche du site allociné. Dans la capture wireshark je retrouve aussi des appels à des endpoint très similaires de ceux décrit dans l’article de Gromez mais qui ne m’apporte pas les informations que je désire.</p><p>A l’exception d’un, qui lui est intéressant:</p><p><a href="http://api.allocine.fr/rest/v3/search?filter=movie%2Ctvseries%2Ctheater%2Cperson%2Cvideo%2Cnews%2Cprogram&amp;q=breaking+bad&amp;partner=100ED1DA33EB&amp;mediafmt=mp4-best&amp;profile=large&amp;count=6&amp;format=json&amp;page=1&amp;sed=20200409&amp;sig=%2FCVNs8c77PzCoWiG6WTOoiOa9L4%3D">http://api.allocine.fr/rest/v3/search?filter=movie%2Ctvseries%2Ctheater%2Cperson%2Cvideo%2Cnews%2Cprogram&amp;q=breaking+bad&amp;partner=100ED1DA33EB&amp;mediafmt=mp4-best&amp;profile=large&amp;count=6&amp;format=json&amp;page=1&amp;sed=20200409&amp;sig=%2FCVNs8c77PzCoWiG6WTOoiOa9L4%3D </a></p><p>Ce endpoint contient les scores dont j’ai besoin et le lien de la fiche du film ou de la série, c’est plutôt pas mal !</p><p><strong>Problème:</strong> L’URL changera dans le temps, le code <code class="highlighter-rouge">partner</code> et <code class="highlighter-rouge">sig</code> sont une sorte de credential ou d’identifiant, c’est un des constats dont faisait l’objet Gromez dans son article.</p><p>Plus mon investigation dure, plus je me rend compte que je passe beaucoup de temps sur quelque chose qui sera amené à évoluer avec le temps. Du coup, que faire ? utiliser l’API pour récupérer les data ? scraper la page ? dans les deux cas c’est soumis à modifications dans le futur…</p><h1 id="la-première-release">La première release</h1><p>J’ai finalement pris la décision de commencer le développement de l’extension en partant sur un workflow “simple”:</p><ul><li>⬇️<strong>Netflix:</strong> Récupération du nom du film ou de la série depuis le <a href="https://fr.wikipedia.org/wiki/Document_Object_Model">DOM</a></li><li>⬇️<strong>Allociné:</strong> Récupération de l’ID et du type (série ou film) depuis le call API de la barre de recherche. Il est à noter qu’au moment où je récupère le nom de la vidéo sur Netflix, je n’ai pas de call XHR ou d’information dans le DOM qui me permet de récupèrer le type de la vidéo (film/série).</li><li>⬇️<strong>Allociné:</strong> Récupération de la note en visitant la fiche du film/série (scraping simple)</li><li>⬇️<strong>NoteFlix:</strong> Création du DOM avec le score Allociné sous forme de pourcentage et insertion de l’objet DOM dans la page Netflix.</li></ul><p>Le workflow fonctionne mais une chose me tracasse… J’ai besoin de connaitre le comportement de l’utilisateur sur Netflix afin de récupérer le DOM qui contient le nom de la vidéo. Si je click sur une vidéo, je veux que le programme cherche la note allociné liée à cette vidéo, pas toutes celles de la page.</p><p>Il y a plusieurs façon de voir les informations d’une série ou d’un film sur Netflix</p><p>En naviguant sur le “board” Netflix <img src="/assets/images/noteflix/jawBone_netflix.png" alt="Breaking bad - Netflix" class="center-image" /></p><p>Ou en allant directement sur la fiche descriptive de la vidéo <img src="/assets/images/noteflix/jawBone_main_netflix.png" alt="Breaking bad - Netflix" class="center-image" /></p><p>La question à se poser est donc: Comment déclencher la récupération de la note en fonction du comportement de l’utilisateur ? Qu’il charge une page ou qu’il click sur une vidéo, le code devra être déclenché à ce moment là.</p><h3 id="mutationobserver">MutationObserver</h3><p>La première idée qui me vient à l’esprit est d’utiliser le <a href="https://developer.mozilla.org/fr/docs/Web/API/MutationObserver">MutationObserver</a>. Le <code class="highlighter-rouge">MutationObserver</code> a pour but d’envoyer des évènements dès que le DOM de la page est modifié.</p><p>Ce qui donnerait quelque chose du genre:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Configuration de l'observer</span>
<span class="kd">const</span> <span class="nx">observerConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">childList</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// Déclenchera un événement si un enfant du noeud est ajouté ou supprimé</span>
  <span class="na">subtree</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// Déclenchera un évènement si les noeuds enfant sont aussi à observer</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">characterData</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="p">};</span>
<span class="kd">const</span> <span class="nx">findRatings</span> <span class="o">=</span> <span class="nx">mutationsList</span> <span class="o">=&gt;</span> <span class="p">{</span>
 <span class="c1">// Cette fonction est appelée uniquement quand un évènement est déclenché par le MutationObserver</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">observer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MutationObserver</span><span class="p">(</span><span class="nx">findRatings</span><span class="p">);</span> <span class="c1">// On lui passe la fonction à appeler quand les évènements se délenchent</span>
<span class="nx">observer</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="nx">observerConfig</span><span class="p">);</span> <span class="c1">// On lui dit d'écouter sur l'objet 'document' (en gros toute la page)</span>
</code></pre></div></div><p>Parfait, on a notre MutationObserver de prêt, il va nous envoyer des évènements pour déclencher notre code mais il y a toujours quelque chose qui ne va pas… Netflix est développé avec React, la page est donc dynamique et va changer très souvent. Le risque ? Une surcharge d’évènements ! Si on écoute toutes les modifications du document, on va vite se retrouver avec des évènements déclenchés alors qu’ils ne nous seront d’aucune utilité. Par exemple si je glisse ma souris sur mon avatar, un menu apparaitra et un évènement sera déclenché alors que j’aimerais n’avoir que les évènement qui touche aux vidéos.</p><p>Peaufinons un peu notre MutationObserver:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">observer</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'[role=main]'</span><span class="p">),</span> <span class="nx">observerConfig</span><span class="p">);</span>
</code></pre></div></div><p>On a donc restreint l’observer à n’écouter que ce qu’il se passe dans le bloc principal de Netflix (celui qui contient toutes les vidéos).</p><p><img src="/assets/images/noteflix/mainview_netflix.png" alt="Main view - Netflix" class="center-image" /></p><p>En plus de restreindre l’observer à écouter un noeud DOM spécifique, on va aussi devoir filtrer sur les évènements reçus.</p><p>Voyons pourquoi avec une illustration simple:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">role=</span><span class="s">"main"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"video"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"video"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"video"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"helper"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"footer"</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div><p>En écoutant <code class="highlighter-rouge">div[role=main]</code> l’observer enverra des évènements pour chaque ajout/suppression/modifications de ses enfants. Si une des <code class="highlighter-rouge">div.video</code> change, un évènement sera déclenché et de même pour <code class="highlighter-rouge">div.helper</code> ou <code class="highlighter-rouge">div.footer</code> alors qu’ils ne nous intéressent pas.</p><p>Quand le MutationObserver est déclenché, il renvoie une liste de <a href="https://developer.mozilla.org/fr/docs/Web/API/MutationRecord">MutationRecord</a>. On peut donc encore un peu plus affiner notre code afin qu’il n’accepte que les évènements issus de noeuds qui nous intéressent:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">findRatings</span> <span class="o">=</span> <span class="nx">mutationsList</span> <span class="o">=&gt;</span> <span class="p">{</span>
 <span class="c1">// Cette fonction est appelée uniquement quand un évènement est déclenché par le MutationObserver</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">mutationRecord</span> <span class="k">of</span> <span class="nx">mutationsList</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mutationRecord</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">'video'</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// Do something ...</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="le-cache">Le cache</h3><p>Maintenant que le code se déclenche bien au bon moment je me confronte à un autre problème, celui des appels multiples à allociné. Chaque fois que la page est modifiée je vais devoir appeler Allociné pour récupérer les informations de la vidéo, un appel HTTP pouvant prendre du temps, ne serait-ce pas judicieux de faire un système de cache ? Je pourrais y stocker les informations et rating liées aux vidéos, si le cache contient la donnée je l’affiche directement et sinon je demande à Allociné l’information.</p><p>Il y a plusieurs moyens de gérer un cache coté navigateur, on peut:</p><ul><li>Créer une classe javascript très basique qui s’occuperait de garder les données en mémoire.</li><li>Créer un <a href="https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/cookies/set">cookie</a></li><li>Utiliser le <a href="https://developer.mozilla.org/fr/docs/Web/API/Window/localStorage">localStorage</a></li><li>Utiliser le <a href="https://developer.mozilla.org/fr/docs/Web/API/Window/sessionStorage">sessionStorage</a></li></ul><p>Le <strong>Cookie</strong> étant généralement utilisé pour contenir de l’information qui sera ensuite envoyer au serveur (sessionID, authentification etc.) et n’ayant aucun serveur pour NoteFlix, nous pouvons l’évincer d’office.</p><p><strong>LocalStorage</strong> nous permet de stocker de la donnée qui perdurera dans le temps, si on coupe et relance son navigateur, le <code class="highlighter-rouge">localStorage</code> sera toujours à l’état avant fermeture du navigateur. Il pourrait convenir à notre besoin mais il faudrait prendre en compte le fait qu’entre chaque version de l’extension, la donnée qui est en cache coté client peut potentiellement être au format de versions antérieurs. Si le model du cache change, il va falloir le purger ou gérer des migrations, un sytème de rétention etc.. ca risque d’ajouter une complexité supplémentaire pour une première version.</p><p>Il nous reste donc la création d’une classe et l’utilisation de <strong>SessionStorage</strong>. Pour la première release de l’extension je suis parti sur une classe simple puis j’ai rapidement modifiée cette classe pour qu’elle se charge de déléguer la sauvegarde des données au SessionStorage.</p><p>Le <strong>SessionStorage</strong> n’acceptant que du clé-valeur, ma classe ne se charge que de serializer/désérializer en JSON, voilà comment ca se présente:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">md5</span> <span class="k">from</span> <span class="s1">'blueimp-md5'</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="nx">Cache</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">=</span> <span class="s1">'noteflix_'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">save</span><span class="p">(</span><span class="nx">videoInfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">videoInfo</span><span class="p">.</span><span class="nx">hashId</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">videoInfo</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">+</span> <span class="nx">videoInfo</span><span class="p">.</span><span class="nx">hashId</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">videoInfo</span><span class="p">));</span>

    <span class="k">return</span> <span class="nx">videoInfo</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">get</span><span class="p">(</span><span class="nx">videoName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">hashId</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">videoName</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">+</span> <span class="nx">hashId</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">exists</span><span class="p">(</span><span class="nx">videoName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">hashId</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">videoName</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">+</span> <span class="nx">hashId</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h1 id="le-verdict">Le verdict</h1><p>Une fois toute la logique réalisée, j’ai publié l’extension sur <a href="https://addons.mozilla.org/fr/firefox/addon/noteflix/">le store de Firefox</a> puis j’ai rapidement remarqué que le <a href="#mutationobserver">MutationObserver</a> posait problème. Parfois l’extension se retrouvait à recevoir 2 ou 3 évènements simultanées pour le même noeud DOM, ou parfois elle ne recevait aucun évènement, du coup elle n’affichait rien.</p><p>Pas top pour un utilisateur qui s’attend à avoir un score d’affiché …</p><p>J’ai donc décidé de retirer le MutationObserver le temps de trouver une solution plus propre et de passer par un simple <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval">setInterval</a></p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Manager</span> <span class="k">from</span> <span class="s1">'./dom/Manager'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Manager</span><span class="p">();</span>
<span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">manager</span><span class="p">.</span><span class="nx">refreshRatings</span><span class="p">();</span>
<span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>
</code></pre></div></div><p>L’avantage de passer par <code class="highlighter-rouge">setInterval</code>, c’est qu’on ne soucis plus de la modification du DOM (donc du code en moins). L’inconvénient c’est que toutes les 2 secondes une partie du code est executée pour vérifier si l’on doit chercher la note allociné ou non.</p><p>Le contrat est rempli, l’extension fait plutôt bien son job 🎉</p><p>J’ai encore quelques nice-to-have à intégrer à l’extension comme par exemple le fait de récupérer le rating allociné directement depuis <a href="https://developers.google.com/search/docs/guides/intro-structured-data">les données structurées</a>:</p><p><img src="/assets/images/noteflix/structured_data_allocine.png" alt="Données structurées - Allociné" class="center-image" /></p><p>Ce qui m’éviterait de récupérer la note en scrapant la page.</p><p>J’envisage aussi de porter l’extension sur Chrome parceque tout le monde n’utilise pas firefox…</p><h3 id="liens">Liens</h3><p><a href="https://addons.mozilla.org/fr/firefox/addon/noteflix/">Télécharger l’extension pour Firefox</a></p><p><a href="https://github.com/bt0r/NoteFlix">Code source</a></p><p><strong>Edit:</strong> <a href="https://chrome.google.com/webstore/detail/noteflix/ahoplkcmcgpbkimjhncpnnllgikapjoj?hl=fr">Télécharger l’extension pour Chrome</a></p></div><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Noteflix: Une extension firefox pour voir les notes Allociné sur Netflix+https://btor.fr/2020/04/07/noteflix-allocine-netflix/+by+Thibaut BAYER" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://plus.google.com/share?url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-google-plus"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Noteflix: Une extension firefox pour voir les notes Allociné sur Netflix&summary=&url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.stumbleupon.com/badge/?url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-stumbleupon"></i></a></li><li><a href="https://www.reddit.com/submit?url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li><li><a href="https://www.tumblr.com/share/link?url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-tumblr"></i></a></li><li><a href="https://www.pinterest.com/pin/create/link/?description=&media=https://btor.fr/assets/images/noteflix/main.png&url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-pinterest"></i></a></li></ul></div></div><div class="section-padding--none"><div class="grid"><hr class="sep"/></div></div><div class="section-padding"><div class="grid-small"> <span class="post__author">Posté par <a href="http://btor.fr" title="More By Thibaut BAYER">Thibaut BAYER</a></span><p class="post__bio">Passionné d'informatique, de développement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech !</p></div></div></article></div><section class="related section-padding"><div class="grid-xlarge"><h2 class="related__title"></h2><div class="related__container"><article class="related__post"> <a class="related__link" href="https://btor.fr/2020/04/07/noteflix-allocine-netflix/"><figure class="related__img"> <img src="/assets/images/noteflix/main.png" alt="Noteflix: Une extension firefox pour voir les notes Allociné sur Netflix"/></figure><div><h2 class="related__text">Noteflix: Une extension firefox pour voir les notes Allociné sur Netflix</h2></div></a></article></div></div></section></main><footer class="footer section-padding"><div class="grid"><div class="subscribe" id="subscribe"><div class="subscribe__container"> <span class="subscribe__title">Restons en contact</span><ul class="footer__social"><li><a href="https://twitter.com/biiitor" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://www.instagram.com/btor.fr/" target="_blank"><i class="fa fa-instagram"></i></a></li><li><a href="https://www.linkedin.com/in/thibaut-bayer//" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://github.com/bt0r" target="_blank"><i class="fa fa-github"></i></a></li><li><a href="https://twitch.tv/bt0r" target="_blank"><i class="fa fa-twitch"></i></a></li></ul></div></div><hr class="sep--white"/><div class="footer__container"><p>Catégories</p><ul class="footer__tags"><li><a class="footer__link" href="/tag/materiel">Materiel</a></li><li><a class="footer__link" href="/tag/test">Test</a></li><li><a class="footer__link" href="/tag/javascript">Javascript</a></li><li><a class="footer__link" href="/tag/tutorial">Tutorial</a></li><li><a class="footer__link" href="/tag/infrastructure">Infrastructure</a></li></ul></div></div></footer><section class="contact popup"><div class="popup__close"><div class="popup__exit"></div></div><div class="contact__container popup__container"><div class="contact__img"><figure class="absolute-bg" style="background-image: url(/assets/images/logo/logo.dark.small.png);"></figure></div><div class="contact__content"><div class="contact__mast section-padding--half"><div class="grid"><h2>Contact</h2></div></div><div class="section-padding--none"><hr class="sep"/></div><div class="contact__form section-padding--half"><div class="grid-xlarge"> <form id="form" class="form" action="https://formcarry.com/s/HkIo0nMb7" method="POST"><div class="form__subcontainer"><div> <label for="form-first-name">First Name</label> <input type="text" name="first-name" id="form-first-name" required></div><div> <label for="form-last-name">Last Name</label> <input type="text" name="last-name" id="form-last-name" required></div></div><div> <label for="form-email">E-Mail</label> <input type="email" name="email" id="form-email" required></div><div> <label for="form-message">Message</label> <textarea name="message" id="form-message" rows="3"></textarea></div><div class="form__submit"><div class="form__btn"> <input type="submit" value="Send"></div></div><p class="form__message"></p></form></div></div></div></div></section><script src="/assets/js/app.min.js"></script></body></html>
  