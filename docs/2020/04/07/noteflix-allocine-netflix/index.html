<!DOCTYPE html><html lang="en"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Noteflix: Une extension firefox pour voir les notes AllocinÃ© sur Netflix | btor.fr</title><meta name="description" content="PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta itemprop="name" content="Thibaut BAYER"><meta itemprop="description" content="PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta itemprop="image" content="https://btor.fr/assets/images/noteflix/main.png"><meta property="og:url" content="https://btor.fr/2020/04/07/noteflix-allocine-netflix/"><meta property="og:type" content="website"><meta property="og:title" content="Noteflix: Une extension firefox pour voir les notes AllocinÃ© sur Netflix | btor.fr"><meta property="og:site_name" content="btor.fr"><meta property="og:description" content="PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta property="og:image" content="https://btor.fr/assets/images/noteflix/main.png"><meta name="twitter:url" content="https://btor.fr/2020/04/07/noteflix-allocine-netflix/"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Noteflix: Une extension firefox pour voir les notes AllocinÃ© sur Netflix | btor.fr"><meta name="twitter:site" content="btor.fr"><meta name="twitter:description" content="PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech ! "><meta name="twitter:creator" content="@biiitor"><meta property="twitter:image" content="https://btor.fr/assets/images/noteflix/main.png"><link rel="icon" type="image/x-icon" href="/assets/images/favicon.ico"><link rel="stylesheet" href="/assets/css/app.min.css"><link rel="alternate" type="application/rss+xml" title="btor.fr" href="/feed.xml"><link rel="canonical" href="/2020/04/07/noteflix-allocine-netflix/"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-153641953-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-153641953-1'); </script></head><body id="noteflix-une-extension-firefox-pour-voir-les-notes-allocinÃ©-sur-netflix" class="post-layout"><header class="header"> <a class="header__title" href="https://btor.fr/"><img width="75" src="/assets/images/logo/logo.dark.small.png"/></a><nav><ul class="header__list"><li><a href="/qui-suis-je">â“ Qui suis-je</a></li></ul></nav></header><main class="ğŸ’ˆ"><div class="post"><article itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting"><div class="post__header section-padding--double"><div class="grid-small"><h2 itemprop="name headline">Noteflix: Une extension firefox pour voir les notes AllocinÃ© sur Netflix</h2><time class="post__date" datetime="2020-04-07T00:00:00-05:00" itemprop="datePublished">07/04/2020</time></div></div><div class="post__img"><div><figure class="absolute-bg" style="background-image: url('/assets/images/noteflix/main.png');"></figure></div></div><div class="post__content section-padding"><div class="grid"><div id="markdown" itemprop="articleBody"><p>Comme bon nombre dâ€™entre vous, je profite du confinement pour avancer sur des projets personnels. Jeudi dernier, aprÃ¨s avoir passÃ© prÃ¨s de 4h Ã  coder sur un projet personnel en react-native, je me suis dis :</p><blockquote><p>Â Et si je me mettais une petite sÃ©rie Netflix ?</p></blockquote><p>Ni une, ni deux, jâ€™ouvre Netflix et commence Ã  chercher LA sÃ©rie qui va me tenir en haleine sur les prochains jours. ProblÃ¨me, il mâ€™arrive souvent de tomber sur des sÃ©ries un peu naze comme <a href="http://www.allocine.fr/series/ficheserie_gen_cserie=24219.html">Marianne</a>, cette bouse comiquo-horrifique @@NO.</p><p>Câ€™est Ã  ce moment prÃ©cis quâ€™il me vint Ã  lâ€™esprit une idÃ©e de gÃ©nie</p><blockquote><p>Ã‡a pourrait Ãªtre pas mal dâ€™avoir un meilleur indicateur de notes des films et sÃ©ries netflix !</p></blockquote><p><img src="https://media.giphy.com/media/l0LEIXSRRuv9QQIRNI/giphy.gif" alt="" class="center-image" /> <em>21h, la dÃ©cision est prise: Je me lance dans le dÃ©veloppement dâ€™une extension firefox pour rÃ©cupÃ©rer les notes <a href="https://allocine.fr">allocinÃ©</a> afin de les intÃ©grer Ã  Netflix.</em></p><h1 id="les-premiers-balbutiements">Les premiers balbutiements</h1><p>Quand on commence un nouveau projet, on a toujours envie de commencer fort, dâ€™utiliser la derniÃ¨re techno Ã  la mode, de ne pas rÃ©flÃ©chir et â€œpisser du codeâ€ vite, trÃ¨s vite !</p><p>Câ€™est pourtant tout ce quâ€™il ne faut pas faire. Le plus dur câ€™est justement de bien rÃ©flÃ©chir aux choix techniques, aux risques, Ã  pondÃ©rer chaque technos pour ses avantages et inconvÃ©nients etc..</p><p><strong>BREF</strong>, câ€™est chiant mais on a souvent pas le choix !</p><p>â€¦</p><p><strong>SAUF</strong> quand tu codes une extension Firefox pour un side project dont tu te contrefous de la derniÃ¨re techno Ã  la mode puisque de toute facon tu feras au mieux du Typescript transpilÃ© pour aller dans un environement cloisonnÃ©. @@LUL</p><p>Je nâ€™avais donc pas beaucoup de questions Ã  me poser, je savais que jâ€™allais partir sur du Javascript ou au mieux du Typescript et que le code ne serait pas trÃ¨s complexe Ã©tant donnÃ© que Ã§a serait quâ€™un simple appel ajax Ã  lâ€™API dâ€™AllocinÃ©. Du moins, câ€™est ce que je croyais @@SAD</p><p>Jâ€™avais dÃ©jÃ  rÃ©alisÃ© une petite extension Firefox sans lâ€™avoir publiÃ© sur le store de Mozilla, je partais donc avec un lÃ©ger avantage de ce cÃ´tÃ© lÃ . Par contre, je nâ€™avais jamais regardÃ© de prÃ¨s comment fonctionne le site dâ€™allocinÃ©. Ce nâ€™est pas un site que je regarde rÃ©guliÃ¨rement mais câ€™est en gÃ©nÃ©ral le premier que je vais voir quand je recherche une information sur un film ou une sÃ©rie (dâ€™ou mon choix de lâ€™intÃ©grer Ã  Netflix)</p><p>Jâ€™ai donc commencÃ© ce side-project en me faisant un petit repository GitHub avec un bootstrap dâ€™extension pour juste faire mes premiers crash-tests. Avant de mâ€™attaquer Ã  Netflix, je voulais mâ€™assurer quâ€™il Ã©tait possible de rÃ©cupÃ©rer les notes de films/sÃ©ries depuis lâ€™APIÂ dâ€™allocine.</p><p>Je pars convaincu, serein, frais comme un gardon, bref jâ€™suis chaud @@PROUD</p><p>Jâ€™arrive sur le site dâ€™allocinÃ© et je commence Ã  investiguer un peu ce quâ€™il se passe sur le site:</p><ul><li>F12, onglet rÃ©seaux, est ce quâ€™il y a des call XHRÂ au chargement de la page ? Nope ! @@NO</li><li>Je regarde les diffÃ©rents input afin de voir si certains marchent en Ajax, bingo ! celui de la barre de recherche fait un call ajax @@HEY</li></ul><p><img src="/assets/images/noteflix/search_allocine.png" alt="Barre de recherche AllocinÃ©" class="center-image" /></p><p>Voyons un peu ce que Ã§a donne en recherchant <a href="http://www.allocine.fr/_/autocomplete/breaking%20bad">Breaking bad</a>:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"error"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="s2">"message"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="w">
  </span><span class="s2">"results"</span><span class="p">:[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"entity_type"</span><span class="p">:</span><span class="s2">"series"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"entity_id"</span><span class="p">:</span><span class="s2">"3517"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"gid"</span><span class="p">:</span><span class="s2">"series.series._.3517"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"label"</span><span class="p">:</span><span class="s2">"Breaking Bad"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"facet"</span><span class="p">:</span><span class="s2">"series"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"original_label"</span><span class="p">:</span><span class="s2">"Breaking Bad"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"text_search_data"</span><span class="p">:[</span><span class="w">
        </span><span class="s2">"BrBa"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="s2">"status"</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="w">
      </span><span class="s2">"viewcount"</span><span class="p">:</span><span class="mi">975962</span><span class="p">,</span><span class="w">
      </span><span class="s2">"irankpopular"</span><span class="p">:</span><span class="mi">41</span><span class="p">,</span><span class="w">
      </span><span class="s2">"browsable"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="s2">"last_release"</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="s2">"data"</span><span class="p">:{</span><span class="w">
        </span><span class="s2">"id"</span><span class="p">:</span><span class="mi">3517</span><span class="p">,</span><span class="w">
        </span><span class="s2">"year"</span><span class="p">:</span><span class="s2">"2008"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"is_program"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="s2">"poster_path"</span><span class="p">:</span><span class="s2">"</span><span class="se">\/</span><span class="s2">pictures</span><span class="se">\/</span><span class="s2">19</span><span class="se">\/</span><span class="s2">06</span><span class="se">\/</span><span class="s2">18</span><span class="se">\/</span><span class="s2">12</span><span class="se">\/</span><span class="s2">11</span><span class="se">\/</span><span class="s2">3956503.jpg"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"creator_name"</span><span class="p">:[</span><span class="w">
          </span><span class="s2">"Vince Gilligan"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"showrunner_name"</span><span class="p">:[</span><span class="w">
          </span><span class="s2">"Vince Gilligan"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"thumbnail"</span><span class="p">:</span><span class="s2">"http:</span><span class="se">\/\/</span><span class="s2">fr.web.img6.acsta.net</span><span class="se">\/</span><span class="s2">c_75_100</span><span class="se">\/</span><span class="s2">pictures</span><span class="se">\/</span><span class="s2">19</span><span class="se">\/</span><span class="s2">06</span><span class="se">\/</span><span class="s2">18</span><span class="se">\/</span><span class="s2">12</span><span class="se">\/</span><span class="s2">11</span><span class="se">\/</span><span class="s2">3956503.jpg"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"scores"</span><span class="p">:{</span><span class="w">
        </span><span class="s2">"rating_score"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="w">
        </span><span class="s2">"weekly_rank_score"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="s2">"all_time_rank_score"</span><span class="p">:</span><span class="mi">5</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"genres"</span><span class="p">:[</span><span class="w">
        </span><span class="s2">"Drama"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="s2">"tags"</span><span class="p">:[</span><span class="w">
        </span><span class="s2">"Series.Type.Series"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Series.Status.Ended"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Info.Genre.Drama"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Format.Color.Color"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="s2">"last_updated_at"</span><span class="p">:</span><span class="s2">"2020-03-27T08:16:53.320000+01:00"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"index"</span><span class="p">:</span><span class="s2">"search_ac_20200408070105"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"type"</span><span class="p">:</span><span class="s2">"search"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"id"</span><span class="p">:</span><span class="s2">"series.series._.3517"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"score"</span><span class="p">:</span><span class="mf">23897.488</span><span class="p">,</span><span class="w">
      </span><span class="s2">"sponsored"</span><span class="p">:</span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>On remarque que le format de rÃ©ponse est assez light, 3 champs dont un qui nous intÃ©resse <code class="highlighter-rouge">results</code>, qui contient les objets rÃ©pondant Ã  notre recherche. Ces objets peuvent Ãªtre des films, sÃ©ries ou des personnalitÃ©s.Â Câ€™est dÃ©jÃ  une premiÃ¨re Ã©tape Ã  garder en tÃªte vu quâ€™on ne voudra que ce qui est films ou sÃ©ries.</p><p>On y trouve aussi un objet <code class="highlighter-rouge">scores</code>, intÃ©ressant !</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"scores"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"rating_score"</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="w">
        </span><span class="s2">"weekly_rank_score"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="s2">"all_time_rank_score"</span><span class="p">:</span><span class="mi">5</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>Parfait, je regarde donc Ã  quoi correspondent ces scores, voir si ils correspondent Ã  ce que je recherche (en lâ€™occurence, les notes des spectateurs).</p><p><img src="/assets/images/noteflix/scores_allocine.png" alt="Score allocinÃ©" class="center-image" /></p><p>Jeanne @@JEANNE ! Au secours ! Dâ€™oÃ¹ proviennent ces scores ? Jâ€™ai beau tester avec 2Â ou 3 autres films/sÃ©ries, aucune corrÃ©lation nâ€™est envisageable.</p><p>Je continue donc mon investigation en fouinant sur le site mais rien nâ€™y fait, je ne trouve aucune donnÃ©e viable via une API. Je dÃ©cide donc de regarder un peu sur google et je tombe sur le blog dâ€™un certains <a href="https://wiki.gromez.fr/dev/api/allocine_v3">Gromez qui parle de lâ€™API dâ€™AllocinÃ©</a>.</p><p>Lâ€™article est vieux (2013) mais trÃ¨s intÃ©ressant, il parle des diffÃ©rents endpoint quâ€™il a pu trouver en regardant le comportement de lâ€™app mobile via un <a href="https://fr.wikipedia.org/wiki/Analyseur_de_paquets">analyseur de paquet</a>.</p><p>Malheureusement, lâ€™article Ã©tant datÃ©, les liens et token fournis le sont aussi. Je dÃ©cide donc Ã  mon tour de regarder comment se comporte lâ€™application mobile.</p><h1 id="analyse-de-paquet">Analyse de paquet</h1><p>En gÃ©nÃ©ral quand je cherche Ã  avoir des infos sur une API, je regarde comment lâ€™application mobile fonctionne. Pour ce faire, je me charge de capturer les paquets IP qui sortent de mon tÃ©lÃ©phone et je regarde ce qui concerne lâ€™application.</p><p>Auparavant jâ€™utilisais BitShark, une application de capture de flux IPÂ qui me permettait de gÃ©nÃ©rer un fichier .pcap que jâ€™ouvrais ensuite dans Wireshark. Ca marche mais câ€™est vite chiant de devoir transfÃ©rer les .pcap sur un ordinateur pour ensuite faire lâ€™analyse. De plus, cette application ne semble plus Ãªtre dans le store Android.</p><p>En fouinant le store je tombe sur <a href="https://play.google.com/store/apps/details?id=com.egorovandreyrm.pcapremote&amp;hl=fr">PCAPRemote</a> qui a un fonctionnement trÃ¨s basique: il permet de faire de la capture de packet en utilisant sshDump.</p><blockquote><p>Â SSHDump ? KÃ©zako ?</p></blockquote><p>Sshdump va nous permettre de capturer des paquets non pas depuis notre propre machine mais depuis une machine hÃ´te, en lâ€™occurence mon tÃ©lÃ©phone. Le tÃ©lÃ©phone fait office de serveur et mon wireshark de client, fini les envoies de fichier .pcap dâ€™un device Ã  un autre @@SLT !</p><p><img src="/assets/images/noteflix/pcap_remote.png" alt="PCAPRemote" class="center-image" /></p><p>Lâ€™interface est assez simple, le bouton â€œplayâ€ permet de lancer une capture global du smartphone tandis que le bouton â€œPlay 1â€ permet de choisir une application spÃ©cifique.Â  Pratique pour Ã©viter de filtrer Ã  posteriori sur Wireshark !</p><p>Il suffit ensuite de renseigner lâ€™ip et port de lâ€™hÃ´te (le tÃ©lÃ©phone) sur wireshark en utilisant lâ€™option <code class="highlighter-rouge">SSH remote capture: sshdump</code></p><p><img src="/assets/images/noteflix/wireshark_sshdump.png" alt="Wireshark SSHDump" class="center-image" /></p><p>Wireshark reÃ§oit dÃ©sormais les trames IP, jâ€™en profite pour filtrer sur le protocole HTTP afin dâ€™Ã©viter dâ€™Ãªtre flooder de requÃªtes inutiles. Pendant que mon Wireshark tourne, je manipule un peu lâ€™application allocinÃ© afin du gÃ©nÃ©rer du traffic, je recherche, click sur des films, change de pages etc.</p><p>Et quâ€™est ce qui apparait dans Wireshark ? @@LUL</p><p><img src="/assets/images/noteflix/search_wireshark.png" alt="PCAPRemote" class="center-image" /></p><p>Câ€™est exactement le mÃªme endpoint qui Ã©tait utilisÃ© dans la barre de recherche du site allocinÃ©. Dans la capture wireshark je retrouve aussi des appels Ã  des endpoint trÃ¨s similaires de ceux dÃ©crit dans lâ€™article de Gromez mais qui ne mâ€™apporte pas les informations que je dÃ©sire.</p><p>A lâ€™exception dâ€™un, qui lui est intÃ©ressant:</p><p><a href="http://api.allocine.fr/rest/v3/search?filter=movie%2Ctvseries%2Ctheater%2Cperson%2Cvideo%2Cnews%2Cprogram&amp;q=breaking+bad&amp;partner=100ED1DA33EB&amp;mediafmt=mp4-best&amp;profile=large&amp;count=6&amp;format=json&amp;page=1&amp;sed=20200409&amp;sig=%2FCVNs8c77PzCoWiG6WTOoiOa9L4%3D">http://api.allocine.fr/rest/v3/search?filter=movie%2Ctvseries%2Ctheater%2Cperson%2Cvideo%2Cnews%2Cprogram&amp;q=breaking+bad&amp;partner=100ED1DA33EB&amp;mediafmt=mp4-best&amp;profile=large&amp;count=6&amp;format=json&amp;page=1&amp;sed=20200409&amp;sig=%2FCVNs8c77PzCoWiG6WTOoiOa9L4%3D </a></p><p>Ce endpoint contient les scores dont jâ€™ai besoin et le lien de la fiche du film ou de la sÃ©rie, câ€™est plutÃ´t pas mal !</p><p><strong>ProblÃ¨me:</strong> Lâ€™URL changera dans le temps, le code <code class="highlighter-rouge">partner</code> et <code class="highlighter-rouge">sig</code> sont une sorte de credential ou dâ€™identifiant, câ€™est un des constats dont faisait lâ€™objet Gromez dans son article.</p><p>Plus mon investigation dure, plus je me rend compte que je passe beaucoup de temps sur quelque chose qui sera amenÃ© Ã  Ã©voluer avec le temps. Du coup, que faire ? utiliser lâ€™API pour rÃ©cupÃ©rer les data ?Â scraper la page ?Â dans les deux cas câ€™est soumis Ã  modifications dans le futurâ€¦</p><h1 id="la-premiÃ¨re-release">La premiÃ¨re release</h1><p>Jâ€™ai finalement pris la dÃ©cision de commencer le dÃ©veloppement de lâ€™extension en partant sur un workflow â€œsimpleâ€:</p><ul><li>â¬‡ï¸<strong>Netflix:</strong> RÃ©cupÃ©ration du nom du film ou de la sÃ©rie depuis le <a href="https://fr.wikipedia.org/wiki/Document_Object_Model">DOM</a></li><li>â¬‡ï¸<strong>AllocinÃ©:</strong> RÃ©cupÃ©ration de lâ€™IDÂ et du type (sÃ©rie ou film) depuis le call APIÂ de la barre de recherche. Il est Ã  noter quâ€™au moment oÃ¹ je rÃ©cupÃ¨re le nom de la vidÃ©o sur Netflix, je nâ€™ai pas de call XHR ou dâ€™information dans le DOM qui me permet de rÃ©cupÃ¨rer le type de la vidÃ©o (film/sÃ©rie).</li><li>â¬‡ï¸<strong>AllocinÃ©:</strong> RÃ©cupÃ©ration de la note en visitant la fiche du film/sÃ©rie (scraping simple)</li><li>â¬‡ï¸<strong>NoteFlix:</strong> CrÃ©ation du DOM avec le score AllocinÃ© sous forme de pourcentage et insertion de lâ€™objet DOM dans la page Netflix.</li></ul><p>Le workflow fonctionne mais une chose me tracasseâ€¦ Jâ€™ai besoin de connaitre le comportement de lâ€™utilisateur sur Netflix afin de rÃ©cupÃ©rer le DOM qui contient le nom de la vidÃ©o. Si je click sur une vidÃ©o, je veux que le programme cherche la note allocinÃ© liÃ©e Ã  cette vidÃ©o, pas toutes celles de la page.</p><p>Il y a plusieurs faÃ§on de voir les informations dâ€™une sÃ©rie ou dâ€™un film sur Netflix</p><p>En naviguant sur le â€œboardâ€ Netflix <img src="/assets/images/noteflix/jawBone_netflix.png" alt="Breaking bad - Netflix" class="center-image" /></p><p>Ou en allant directement sur la fiche descriptive de la vidÃ©o <img src="/assets/images/noteflix/jawBone_main_netflix.png" alt="Breaking bad - Netflix" class="center-image" /></p><p>La question Ã  se poser est donc: Comment dÃ©clencher la rÃ©cupÃ©ration de la note en fonction du comportement de lâ€™utilisateur ? Quâ€™il charge une page ou quâ€™il click sur une vidÃ©o, le code devra Ãªtre dÃ©clenchÃ© Ã  ce moment lÃ .</p><h3 id="mutationobserver">MutationObserver</h3><p>La premiÃ¨re idÃ©e qui me vient Ã  lâ€™esprit est dâ€™utiliser le <a href="https://developer.mozilla.org/fr/docs/Web/API/MutationObserver">MutationObserver</a>. Le <code class="highlighter-rouge">MutationObserver</code> a pour but dâ€™envoyer des Ã©vÃ¨nements dÃ¨s que le DOM de la page est modifiÃ©.</p><p>Ce qui donnerait quelque chose du genre:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Configuration de l'observer</span>
<span class="kd">const</span> <span class="nx">observerConfig</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">childList</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">//Â DÃ©clenchera un Ã©vÃ©nement si un enfant du noeud est ajoutÃ© ou supprimÃ©</span>
  <span class="na">subtree</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">//Â DÃ©clenchera un Ã©vÃ¨nement si les noeuds enfant sont aussi Ã  observer</span>
  <span class="na">attributes</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="na">characterData</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="p">};</span>
<span class="kd">const</span> <span class="nx">findRatings</span> <span class="o">=</span> <span class="nx">mutationsList</span> <span class="o">=&gt;</span> <span class="p">{</span>
 <span class="c1">// Cette fonction est appelÃ©e uniquement quand un Ã©vÃ¨nement est dÃ©clenchÃ© par le MutationObserver</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">observer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MutationObserver</span><span class="p">(</span><span class="nx">findRatings</span><span class="p">);</span> <span class="c1">//Â On lui passe la fonction Ã  appeler quand les Ã©vÃ¨nements se dÃ©lenchent</span>
<span class="nx">observer</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="nx">observerConfig</span><span class="p">);</span> <span class="c1">//Â On lui dit d'Ã©couter sur l'objet 'document' (en gros toute la page)</span>
</code></pre></div></div><p>Parfait, on a notre MutationObserver de prÃªt, il va nous envoyer des Ã©vÃ¨nements pour dÃ©clencher notre code mais il y a toujours quelque chose qui ne va pasâ€¦ Netflix est dÃ©veloppÃ© avec React, la page est donc dynamique et va changer trÃ¨s souvent. Le risque ? Une surcharge dâ€™Ã©vÃ¨nements ! Si on Ã©coute toutes les modifications du document, on va vite se retrouver avec des Ã©vÃ¨nements dÃ©clenchÃ©s alors quâ€™ils ne nous seront dâ€™aucune utilitÃ©. Par exemple si je glisse ma souris sur mon avatar, un menu apparaitra et un Ã©vÃ¨nement sera dÃ©clenchÃ© alors que jâ€™aimerais nâ€™avoir que les Ã©vÃ¨nement qui touche aux vidÃ©os.</p><p>Peaufinons un peu notre MutationObserver:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">observer</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">'[role=main]'</span><span class="p">),</span> <span class="nx">observerConfig</span><span class="p">);</span>
</code></pre></div></div><p>On a donc restreint lâ€™observer Ã  nâ€™Ã©couter que ce quâ€™il se passe dans le bloc principal de Netflix (celui qui contient toutes les vidÃ©os).</p><p><img src="/assets/images/noteflix/mainview_netflix.png" alt="Main view - Netflix" class="center-image" /></p><p>En plus de restreindre lâ€™observer Ã  Ã©couter un noeud DOM spÃ©cifique, on va aussi devoir filtrer sur les Ã©vÃ¨nements reÃ§us.</p><p>Voyons pourquoi avec une illustration simple:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">role=</span><span class="s">"main"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"video"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"video"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"video"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"helper"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"footer"</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div><p>En Ã©coutant <code class="highlighter-rouge">div[role=main]</code> lâ€™observer enverra des Ã©vÃ¨nements pour chaque ajout/suppression/modifications de ses enfants. Si une des <code class="highlighter-rouge">div.video</code> change, un Ã©vÃ¨nement sera dÃ©clenchÃ© et de mÃªme pour <code class="highlighter-rouge">div.helper</code> ou <code class="highlighter-rouge">div.footer</code> alors quâ€™ils ne nous intÃ©ressent pas.</p><p>Quand le MutationObserver est dÃ©clenchÃ©, il renvoie une liste de <a href="https://developer.mozilla.org/fr/docs/Web/API/MutationRecord">MutationRecord</a>. On peut donc encore un peu plus affiner notre code afin quâ€™il nâ€™accepte que les Ã©vÃ¨nements issus de noeuds qui nous intÃ©ressent:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">findRatings</span> <span class="o">=</span> <span class="nx">mutationsList</span> <span class="o">=&gt;</span> <span class="p">{</span>
 <span class="c1">// Cette fonction est appelÃ©e uniquement quand un Ã©vÃ¨nement est dÃ©clenchÃ© par le MutationObserver</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">mutationRecord</span> <span class="k">of</span> <span class="nx">mutationsList</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mutationRecord</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="s1">'video'</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">//Â Do something ...</span>
      <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h3 id="le-cache">Le cache</h3><p>Maintenant que le code se dÃ©clenche bien au bon moment je me confronte Ã  un autre problÃ¨me, celui des appels multiples Ã  allocinÃ©. Chaque fois que la page est modifiÃ©e je vais devoir appeler AllocinÃ© pour rÃ©cupÃ©rer les informations de la vidÃ©o, un appel HTTPÂ pouvant prendre du temps, ne serait-ce pas judicieux de faire un systÃ¨me de cache ? Je pourrais y stocker les informations et rating liÃ©es aux vidÃ©os, si le cache contient la donnÃ©e je lâ€™affiche directement et sinon je demande Ã  AllocinÃ© lâ€™information.</p><p>Il y a plusieurs moyens de gÃ©rer un cache cotÃ© navigateur, on peut:</p><ul><li>CrÃ©er une classe javascript trÃ¨s basique qui sâ€™occuperait de garder les donnÃ©es en mÃ©moire.</li><li>CrÃ©er un <a href="https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/cookies/set">cookie</a></li><li>Utiliser le <a href="https://developer.mozilla.org/fr/docs/Web/API/Window/localStorage">localStorage</a></li><li>Utiliser le <a href="https://developer.mozilla.org/fr/docs/Web/API/Window/sessionStorage">sessionStorage</a></li></ul><p>Le <strong>Cookie</strong> Ã©tant gÃ©nÃ©ralement utilisÃ© pour contenir de lâ€™information qui sera ensuite envoyer au serveur (sessionID, authentification etc.) et nâ€™ayant aucun serveur pour NoteFlix, nous pouvons lâ€™Ã©vincer dâ€™office.</p><p><strong>LocalStorage</strong> nous permet de stocker de la donnÃ©e qui perdurera dans le temps, si on coupe et relance son navigateur, le <code class="highlighter-rouge">localStorage</code> sera toujours Ã  lâ€™Ã©tat avant fermeture du navigateur. Il pourrait convenir Ã  notre besoin mais il faudrait prendre en compte le fait quâ€™entre chaque version de lâ€™extension, la donnÃ©e qui est en cache cotÃ© client peut potentiellement Ãªtre au format de versions antÃ©rieurs. Si le model du cache change, il va falloir le purger ou gÃ©rer des migrations, un sytÃ¨me de rÃ©tention etc.. ca risque dâ€™ajouter une complexitÃ© supplÃ©mentaire pour une premiÃ¨re version.</p><p>Il nous reste donc la crÃ©ation dâ€™une classe et lâ€™utilisation de <strong>SessionStorage</strong>. Pour la premiÃ¨re release de lâ€™extension je suis parti sur une classe simple puis jâ€™ai rapidement modifiÃ©e cette classe pour quâ€™elle se charge de dÃ©lÃ©guer la sauvegarde des donnÃ©es au SessionStorage.</p><p>Le <strong>SessionStorage</strong> nâ€™acceptant que du clÃ©-valeur, ma classe ne se charge que de serializer/dÃ©sÃ©rializer en JSON, voilÃ  comment ca se prÃ©sente:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">md5</span> <span class="k">from</span> <span class="s1">'blueimp-md5'</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="nx">Cache</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">=</span> <span class="s1">'noteflix_'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">save</span><span class="p">(</span><span class="nx">videoInfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">videoInfo</span><span class="p">.</span><span class="nx">hashId</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">videoInfo</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">+</span> <span class="nx">videoInfo</span><span class="p">.</span><span class="nx">hashId</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">videoInfo</span><span class="p">));</span>

    <span class="k">return</span> <span class="nx">videoInfo</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">get</span><span class="p">(</span><span class="nx">videoName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">hashId</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">videoName</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">+</span> <span class="nx">hashId</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">exists</span><span class="p">(</span><span class="nx">videoName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">hashId</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">videoName</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">prefix</span> <span class="o">+</span> <span class="nx">hashId</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><h1 id="le-verdict">Le verdict</h1><p>Une fois toute la logique rÃ©alisÃ©e, jâ€™ai publiÃ© lâ€™extension sur <a href="https://addons.mozilla.org/fr/firefox/addon/noteflix/">le store de Firefox</a> puis jâ€™ai rapidement remarquÃ© que le <a href="#mutationobserver">MutationObserver</a> posait problÃ¨me. Parfois lâ€™extension se retrouvait Ã  recevoir 2Â ou 3 Ã©vÃ¨nements simultanÃ©es pour le mÃªme noeud DOM, ou parfois elle ne recevait aucun Ã©vÃ¨nement, du coup elle nâ€™affichait rien.</p><p>Pas top pour un utilisateur qui sâ€™attend Ã  avoir un score dâ€™affichÃ© â€¦</p><p>Jâ€™ai donc dÃ©cidÃ© de retirer le MutationObserver le temps de trouver une solution plus propre et de passer par un simple <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setInterval">setInterval</a></p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Manager</span> <span class="k">from</span> <span class="s1">'./dom/Manager'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Manager</span><span class="p">();</span>
<span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">manager</span><span class="p">.</span><span class="nx">refreshRatings</span><span class="p">();</span>
<span class="p">},</span> <span class="mi">2000</span><span class="p">);</span>
</code></pre></div></div><p>Lâ€™avantage de passer par <code class="highlighter-rouge">setInterval</code>, câ€™est quâ€™on ne soucis plus de la modification du DOM (donc du code en moins). Lâ€™inconvÃ©nient câ€™est que toutes les 2Â secondes une partie du code est executÃ©e pour vÃ©rifier si lâ€™on doit chercher la note allocinÃ© ou non.</p><p>Le contrat est rempli, lâ€™extension fait plutÃ´t bien son job ğŸ‰</p><p>Jâ€™ai encore quelques nice-to-have Ã  intÃ©grer Ã  lâ€™extension comme par exemple le fait de rÃ©cupÃ©rer le rating allocinÃ© directement depuis <a href="https://developers.google.com/search/docs/guides/intro-structured-data">les donnÃ©es structurÃ©es</a>:</p><p><img src="/assets/images/noteflix/structured_data_allocine.png" alt="DonnÃ©es structurÃ©es - AllocinÃ©" class="center-image" /></p><p>Ce qui mâ€™Ã©viterait de rÃ©cupÃ©rer la note en scrapant la page.</p><p>Jâ€™envisage aussi de porter lâ€™extension sur Chrome parceque tout le monde nâ€™utilise pas firefoxâ€¦</p><h3 id="liens">Liens</h3><p><a href="https://addons.mozilla.org/fr/firefox/addon/noteflix/">TÃ©lÃ©charger lâ€™extension pour Firefox</a></p><p><a href="https://github.com/bt0r/NoteFlix">Code source</a></p><p><strong>Edit:</strong> <a href="https://chrome.google.com/webstore/detail/noteflix/ahoplkcmcgpbkimjhncpnnllgikapjoj?hl=fr">TÃ©lÃ©charger lâ€™extension pour Chrome</a></p></div><ul class="post__social"><li><a href="https://www.facebook.com/sharer/sharer.php?u=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-facebook"></i></a></li><li><a href="https://twitter.com/intent/tweet?&text=Noteflix: Une extension firefox pour voir les notes AllocinÃ© sur Netflix+https://btor.fr/2020/04/07/noteflix-allocine-netflix/+by+Thibaut BAYER" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://plus.google.com/share?url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-google-plus"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&source=Noteflix: Une extension firefox pour voir les notes AllocinÃ© sur Netflix&summary=&url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://www.stumbleupon.com/badge/?url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-stumbleupon"></i></a></li><li><a href="https://www.reddit.com/submit?url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-reddit-alien"></i></a></li><li><a href="https://www.tumblr.com/share/link?url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-tumblr"></i></a></li><li><a href="https://www.pinterest.com/pin/create/link/?description=&media=https://btor.fr/assets/images/noteflix/main.png&url=https://btor.fr/2020/04/07/noteflix-allocine-netflix/" target="_blank"><i class="fa fa-pinterest"></i></a></li></ul></div></div><div class="section-padding--none"><div class="grid"><hr class="sep"/></div></div><div class="section-padding"><div class="grid-small"> <span class="post__author">PostÃ© par <a href="http://btor.fr" title="More By Thibaut BAYER">Thibaut BAYER</a></span><p class="post__bio">PassionnÃ© d'informatique, de dÃ©veloppement web & applicatif depuis plus de 10 ans. Je partage mon quotidien de tech !</p></div></div></article></div><section class="related section-padding"><div class="grid-xlarge"><h2 class="related__title"></h2><div class="related__container"><article class="related__post"> <a class="related__link" href="https://btor.fr/2020/04/07/noteflix-allocine-netflix/"><figure class="related__img"> <img src="/assets/images/noteflix/main.png" alt="Noteflix: Une extension firefox pour voir les notes AllocinÃ© sur Netflix"/></figure><div><h2 class="related__text">Noteflix: Une extension firefox pour voir les notes AllocinÃ© sur Netflix</h2></div></a></article></div></div></section></main><footer class="footer section-padding"><div class="grid"><div class="subscribe" id="subscribe"><div class="subscribe__container"> <span class="subscribe__title">Restons en contact</span><ul class="footer__social"><li><a href="https://twitter.com/biiitor" target="_blank"><i class="fa fa-twitter"></i></a></li><li><a href="https://www.instagram.com/btor.fr/" target="_blank"><i class="fa fa-instagram"></i></a></li><li><a href="https://www.linkedin.com/in/thibaut-bayer//" target="_blank"><i class="fa fa-linkedin"></i></a></li><li><a href="https://github.com/bt0r" target="_blank"><i class="fa fa-github"></i></a></li><li><a href="https://twitch.tv/bt0r" target="_blank"><i class="fa fa-twitch"></i></a></li></ul></div></div><hr class="sep--white"/><div class="footer__container"><p>CatÃ©gories</p><ul class="footer__tags"><li><a class="footer__link" href="/tag/materiel">Materiel</a></li><li><a class="footer__link" href="/tag/test">Test</a></li><li><a class="footer__link" href="/tag/javascript">Javascript</a></li><li><a class="footer__link" href="/tag/tutorial">Tutorial</a></li><li><a class="footer__link" href="/tag/infrastructure">Infrastructure</a></li></ul></div></div></footer><section class="contact popup"><div class="popup__close"><div class="popup__exit"></div></div><div class="contact__container popup__container"><div class="contact__img"><figure class="absolute-bg" style="background-image: url(/assets/images/logo/logo.dark.small.png);"></figure></div><div class="contact__content"><div class="contact__mast section-padding--half"><div class="grid"><h2>Contact</h2></div></div><div class="section-padding--none"><hr class="sep"/></div><div class="contact__form section-padding--half"><div class="grid-xlarge"> <form id="form" class="form" action="https://formcarry.com/s/HkIo0nMb7" method="POST"><div class="form__subcontainer"><div> <label for="form-first-name">First Name</label> <input type="text" name="first-name" id="form-first-name" required></div><div> <label for="form-last-name">Last Name</label> <input type="text" name="last-name" id="form-last-name" required></div></div><div> <label for="form-email">E-Mail</label> <input type="email" name="email" id="form-email" required></div><div> <label for="form-message">Message</label> <textarea name="message" id="form-message" rows="3"></textarea></div><div class="form__submit"><div class="form__btn"> <input type="submit" value="Send"></div></div><p class="form__message"></p></form></div></div></div></div></section><script src="/assets/js/app.min.js"></script></body></html>
  